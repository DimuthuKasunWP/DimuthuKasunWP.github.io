<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Removing Vulnerability From API Keys Using Serverless Functions</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Removing Vulnerability From API Keys Using Serverless Functions</h1>
</header>
<section data-field="subtitle" class="p-summary">
Imagine you need to develop the front-end of an APP that needs to get a list of the most popular movies from the MovieDB API.
</section>
<section data-field="body" class="e-content">
<section name="beca" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="eabd" id="eabd" class="graf graf--h3 graf--leading graf--title">Removing Vulnerability From API Keys Using Serverless Functions</h3><figure name="0689" id="0689" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 466px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 66.60000000000001%;"></div><img class="graf-image" data-image-id="1*6w3cNUcoTqxSt6hQHCVgIg.jpeg" data-width="1024" data-height="682" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*6w3cNUcoTqxSt6hQHCVgIg.jpeg"></div></figure><p name="9805" id="9805" class="graf graf--p graf-after--figure">Imagine you need to develop the front-end of an APP that needs to get a list of the most popular movies from the <a href="https://developers.themoviedb.org/" data-href="https://developers.themoviedb.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MovieDB</a> API.</p><h3 name="49da" id="49da" class="graf graf--h3 graf-after--p">Let’s do it!</h3><p name="55fb" id="55fb" class="graf graf--p graf-after--h3">Go to <a href="https://developers.themoviedb.org/" data-href="https://developers.themoviedb.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">MovieDB</a> and signup to get your own API Key and follow along.</p><p name="70bc" id="70bc" class="graf graf--p graf-after--p">We will create a new project named <strong class="markup--strong markup--p-strong">protectingapisecrets</strong> using create-react-app and start coding our front-end.</p><pre name="0761" id="0761" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npx create-react-app protectingapisecrets<br>cd protectingapisecrets<br>touch .env<br>npm install axios</code></pre><p name="eb53" id="eb53" class="graf graf--p graf-after--pre">Open this project with your favorite Code Editor, edit your <strong class="markup--strong markup--p-strong">.env</strong> file and add a variable with your API Key.</p><pre name="762e" id="762e" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">// .env<br><br>REACT_APP_API_KEY=&lt;&lt;your api key&gt;&gt;</code></pre><p name="3b2f" id="3b2f" class="graf graf--p graf-after--pre">next open your <strong class="markup--strong markup--p-strong">.gitignore</strong> file and add a line with your <strong class="markup--strong markup--p-strong">.env</strong> file and finally delete all files inside your <strong class="markup--strong markup--p-strong">src</strong> folder and create a clean i*<em class="markup--em markup--p-em">ndex.js</em>* <strong class="markup--strong markup--p-strong">App.js</strong> and <strong class="markup--strong markup--p-strong">App.css.</strong></p><h3 name="d9d1" id="d9d1" class="graf graf--h3 graf-after--p">Start coding</h3><pre name="021e" id="021e" class="graf graf--pre graf-after--h3"><code class="markup--code markup--pre-code">// index.js<br><br>import React from &#39;react&#39;;<br>import ReactDOM from &#39;react-dom&#39;;<br><br>import App from &#39;./App&#39;;<br><br>ReactDOM.render(<br>  &lt;React.StrictMode&gt;<br>    &lt;App /&gt;<br>  &lt;/React.StrictMode&gt;,<br>  document.getElementById(&#39;root&#39;)<br>);</code></pre><pre name="1117" id="1117" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">// App.js<br><br>import React, { useState, useEffect } from &quot;react&quot;<br>import axios from &quot;axios&quot;<br>import &quot;./App.css&quot;<br><br>const App = () =&gt; {<br>  const [movies, setMovies] = useState(null)<br>    <br>    async function fetchMovies() {<br>        const url = `https://api.themoviedb.org/3/movie/popular?api_key=${process.env.REACT_APP_API_KEY}&amp;language=en-US&amp;page=1`<br>      const response = await axios.get(url)<br>        const data = response.data.results<br>        setMovies(data)<br>      }  <br><br>    useEffect(() =&gt; {<br>    fetchMovies()<br>  }, [])<br><br>    return (<br>    &lt;&gt;<br>      {movies === null ? (<br>        &lt;div className=&quot;loading&quot;&gt;<br>          &lt;h2&gt;Loading ...&lt;/h2&gt;<br>        &lt;/div&gt;<br>      ) : (<br>        &lt;&gt;<br>          &lt;div className=&quot;container&quot;&gt;<br>            {movies.map((movie) =&gt; (<br>              &lt;div className=&quot;movie&quot; key={movie.id}&gt;<br>                &lt;img src={`https://image.tmdb.org/t/p/w185/${movie.poster_path}`} alt={movie.title} /&gt;<br>              &lt;/div&gt;<br>            ))}<br>          &lt;/div&gt;<br>        &lt;/&gt;<br>      )}<br>    &lt;/&gt;<br>   )<br>  }<br><br>export default App</code></pre><pre name="9c8b" id="9c8b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">// App.css<br><br>*,<br>*::after,<br>*::before {<br>  margin: 0rem;<br>  padding: 0rem;<br>  box-sizing: inherit;<br>}<br><br>html {<br>  font-size: 62.5%;<br>  scroll-behavior: smooth;<br>}<br><br>body {<br>  box-sizing: border-box;<br>  background-color: #222831;<br>}<br><br>.loading {<br>  padding-top: 5rem;<br>  text-align: center;<br>}<br><br>.loading h2 {<br>  color: white;<br>  font-size: 2rem;<br>}<br><br>.container {<br>  margin: auto;<br>  padding: 2rem;<br>  display: grid;<br>  grid-template-columns: repeat(auto-fill, minmax(20rem, 1fr));<br>  max-width: 110rem;<br>  grid-gap: 2rem;<br>}<br><br>.movie img {<br>  width: 100%;<br>}</code></pre><p name="0f56" id="0f56" class="graf graf--p graf-after--pre">Cool, now let’s run</p><pre name="1afb" id="1afb" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npm start</code></pre><p name="744a" id="744a" class="graf graf--p graf-after--pre">and check if everything is behaving as we expected</p><figure name="00d7" id="00d7" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 510px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 72.8%;"></div><img class="graf-image" data-image-id="1*fUPh-aiiOIh6eqipwV_jzg.jpeg" data-width="880" data-height="641" src="https://cdn-images-1.medium.com/max/800/1*fUPh-aiiOIh6eqipwV_jzg.jpeg"></div></figure><h3 name="5007" id="5007" class="graf graf--h3 graf-after--figure">Deploying</h3><p name="3185" id="3185" class="graf graf--p graf-after--h3">We completed our front-end now it’s time to deploy it.</p><p name="bfdc" id="bfdc" class="graf graf--p graf-after--p">We will do this really easily and in just three steps with Netlify:</p><p name="6ba6" id="6ba6" class="graf graf--p graf-after--p">1st: Create a new GitHub repository and push your code.</p><p name="c218" id="c218" class="graf graf--p graf-after--p">2nd: Create an account on Netlify and connect your account to your GitHub.</p><p name="6758" id="6758" class="graf graf--p graf-after--p">3th: On your Netlify panel select “New Site from git” and chose the repository you created, you also need to check “show advanced” and add a new variable like this :</p><figure name="866c" id="866c" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 628px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 89.8%;"></div><img class="graf-image" data-image-id="1*tXjbu1YVU0OiDpH36xn-Kg.jpeg" data-width="880" data-height="790" src="https://cdn-images-1.medium.com/max/800/1*tXjbu1YVU0OiDpH36xn-Kg.jpeg"></div></figure><p name="41d3" id="41d3" class="graf graf--p graf-after--figure">Click “Deploy Site” and that’s it, we now have a live version of our app!</p><h3 name="594c" id="594c" class="graf graf--h3 graf-after--p">The Problem</h3><p name="c956" id="c956" class="graf graf--p graf-after--h3">We stored our API Key in an environment variable to prevent it from being available on our code but if anyone opens the chrome dev tools while browsing your site, quickly can find your key.</p><figure name="3888" id="3888" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 234px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 33.4%;"></div><img class="graf-image" data-image-id="1*XQXq_JSLJoJ55sVx4VL-7A.jpeg" data-width="880" data-height="294" src="https://cdn-images-1.medium.com/max/800/1*XQXq_JSLJoJ55sVx4VL-7A.jpeg"></div></figure><p name="c594" id="c594" class="graf graf--p graf-after--figure">soo, what can we do to protect our API key?</p><h3 name="a426" id="a426" class="graf graf--h3 graf-after--p">Serverless Functions</h3><p name="8e28" id="8e28" class="graf graf--p graf-after--h3">We can make a serverless function that handles our API call for us so we don’t have to publicly expose our key.</p><p name="0ee1" id="0ee1" class="graf graf--p graf-after--p">Let’s try it out, go back to your terminal, and run:</p><pre name="30a4" id="30a4" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npm install netlify-lambda http-proxy-middleware env-cmd<br>mkdir functions<br>touch netlify.toml</code></pre><p name="ab52" id="ab52" class="graf graf--p graf-after--pre">Update scripts in your <strong class="markup--strong markup--p-strong">package.json</strong> file to look like this:</p><pre name="b233" id="b233" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">// package.json<br><br>&quot;scripts&quot;: {<br>    &quot;start&quot;: &quot;react-scripts start&quot;,<br>    &quot;build&quot;: &quot;react-scripts build&quot;,<br>    &quot;test&quot;: &quot;react-scripts test&quot;,<br>    &quot;eject&quot;: &quot;react-scripts eject&quot;,<br>        &quot;lambda-serve&quot;: &quot;env-cmd netlify-lambda serve functions&quot;,<br>        &quot;lambda-build&quot;: &quot;netlify-lambda build functions&quot;<br>  },</code></pre><p name="5aac" id="5aac" class="graf graf--p graf-after--pre">add this lines to <strong class="markup--strong markup--p-strong">netlify.toml</strong> file and add the functions folder to your <strong class="markup--strong markup--p-strong">.gitignorefile</strong></p><pre name="da60" id="da60" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">// netlify.toml<br><br>[build]<br>    functions = &quot;lambda&quot;</code></pre><p name="e8f0" id="e8f0" class="graf graf--p graf-after--pre">add a file named <strong class="markup--strong markup--p-strong">setupProxy.js</strong> to your <strong class="markup--strong markup--p-strong">src</strong> folder and past this code:</p><pre name="06b4" id="06b4" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">// setupProxy.js<br><br>const { createProxyMiddleware } = require(&#39;http-proxy-middleware&#39;);<br><br>module.exports = function(app) {<br>  app.use(<br>    &#39;/.netlify/functions/&#39;,<br>    createProxyMiddleware({<br>      target: &#39;http://localhost:9000&#39;,<br>      &quot;pathRewrite&quot;: {<br>        &quot;^/\\.netlify/functions&quot;: &quot;&quot;<br>      }<br>    })<br>  );<br>};</code></pre><p name="8b9d" id="8b9d" class="graf graf--p graf-after--pre">This proxy setup will allow you to ping different endpoints depending on which environment you are if you are in development you want to ping <strong class="markup--strong markup--p-strong">localhost</strong> and in production you want the <strong class="markup--strong markup--p-strong">./netlify/functions</strong> endpoint.</p><h3 name="3f7b" id="3f7b" class="graf graf--h3 graf-after--p">Coding our function</h3><p name="2943" id="2943" class="graf graf--p graf-after--h3">Let’s create a file named <strong class="markup--strong markup--p-strong">getMovies.js</strong> inside our <strong class="markup--strong markup--p-strong">functions</strong> directory</p><pre name="7d05" id="7d05" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">// getMovies.js<br><br>const axios = require(&quot;axios&quot;)<br><br>exports.handler = function(event, context, callback) {<br>    const { API_KEY } = process.env<br><br>    const url = `https://api.themoviedb.org/3/movie/popular?api_key=${API_KEY}&amp;language=en-US&amp;page=1`<br><br>    const send = body =&gt; {<br>        callback(null, {<br>            statusCode: 200,<br>            body: JSON.stringify(body)<br>        })<br>    }<br><br>    const getMovies = async () =&gt; {<br>        const response = await axios.get(url)<br>        const data = response.data.results<br><br>        send(data)<br>    }<br><br>    getMovies()<br>}</code></pre><p name="57a2" id="57a2" class="graf graf--p graf-after--pre">Now we need to edit our <strong class="markup--strong markup--p-strong">fetchMovies</strong> function inside <strong class="markup--strong markup--p-strong">App.js</strong> to use the serverless function instead of pinging the moviedb api directly:</p><pre name="19d5" id="19d5" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">async function fetchMovies() {<br>    const url = `/.netlify/functions/getMovies`<br><br>    const response = await axios.get(url)<br>    const data = response.data<br>    setMovies(data)<br>  }</code></pre><p name="35b7" id="35b7" class="graf graf--p graf-after--pre">And finally, edit the <strong class="markup--strong markup--p-strong">.env</strong> file and change the name of the variable from <strong class="markup--strong markup--p-strong">REACT_APP_API_KEY</strong> to <strong class="markup--strong markup--p-strong">API_KEY</strong></p><h3 name="75f2" id="75f2" class="graf graf--h3 graf-after--p">Great, let’s test it out!</h3><p name="9bf7" id="9bf7" class="graf graf--p graf-after--h3">Open two terminal windows and run <strong class="markup--strong markup--p-strong">npm start</strong> on the first and <strong class="markup--strong markup--p-strong">npm run lambda-serve</strong> on the second one and check your network tab.</p><figure name="89ee" id="89ee" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 176px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 25.1%;"></div><img class="graf-image" data-image-id="1*_kD97UVBnyXFI84w9sdPLQ.jpeg" data-width="709" data-height="178" src="https://cdn-images-1.medium.com/max/800/1*_kD97UVBnyXFI84w9sdPLQ.jpeg"></div></figure><p name="7095" id="7095" class="graf graf--p graf-after--figure">Cool, we are calling the serverless function hiding the real endpoint of the api, let’s deploy it to Netlify, open your terminal and run:</p><pre name="b4da" id="b4da" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">git add .<br>git commit -m &quot;finished version&quot;<br>git push</code></pre><p name="03a6" id="03a6" class="graf graf--p graf-after--pre">When you push a commit to your GitHub repo Netlify will trigger a new deploy for your site. You just need to do one extra step and you are done, open your Netlify Panel and change the name of the environment variable you created on your fist deploy from <strong class="markup--strong markup--p-strong">REACT_APP_API_KEY</strong> to <strong class="markup--strong markup--p-strong">API_KEY</strong></p><figure name="3e3f" id="3e3f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 139px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 19.900000000000002%;"></div><img class="graf-image" data-image-id="1*xJflzr0b1edbV8JRVjs70w.jpeg" data-width="880" data-height="175" src="https://cdn-images-1.medium.com/max/800/1*xJflzr0b1edbV8JRVjs70w.jpeg"></div></figure><p name="4b83" id="4b83" class="graf graf--p graf-after--figure">We are done, see you soon!</p><p name="0965" id="0965" class="graf graf--p graf-after--p">My deployed version here: <a href="https://protectingapisecrets.netlify.app/" data-href="https://protectingapisecrets.netlify.app/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://protectingapisecrets.netlify.app/</a></p><p name="58f8" id="58f8" class="graf graf--p graf-after--p graf--trailing">npm install axios</p></div></div></section>
</section>
</article></body></html>