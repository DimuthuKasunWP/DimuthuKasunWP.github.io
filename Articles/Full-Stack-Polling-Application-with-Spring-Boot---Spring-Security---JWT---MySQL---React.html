<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Full Stack Polling Application with Spring Boot &amp; Spring Security &amp; JWT &amp; MySQL &amp; React</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Full Stack Polling Application with Spring Boot &amp; Spring Security &amp; JWT &amp; MySQL &amp; React</h1>
</header>
<section data-field="subtitle" class="p-summary">
Hello and Welcome to the first part of an exciting series of blog posts where you will learn how to build an end-to-end full stack polling…
</section>
<section data-field="body" class="e-content">
<section name="33ce" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="ff70" id="ff70" class="graf graf--h3 graf--leading graf--title">Full Stack Polling Application with Spring Boot &amp; Spring Security &amp; JWT &amp; MySQL &amp; React</h3><figure name="3081" id="3081" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 280px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40%;"></div><img class="graf-image" data-image-id="1*4uKblBk9te0n9Ou5VsnC1w.jpeg" data-width="750" data-height="300" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*4uKblBk9te0n9Ou5VsnC1w.jpeg"></div></figure><p name="7bf9" id="7bf9" class="graf graf--p graf-after--figure">Hello and Welcome to the first part of an exciting series of blog posts where you will learn how to build an end-to-end full stack polling app similar to twitter polls.</p><p name="98ee" id="98ee" class="graf graf--p graf-after--p">We’ll build the backend server using Spring Boot where we’ll use Spring Security along with JWT authentication. We’ll use MySQL database for storage.</p><p name="6a98" id="6a98" class="graf graf--p graf-after--p">The front-end application will be built using <a href="https://reactjs.org/" data-href="https://reactjs.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">React</a>. We’ll also use <a href="https://ant.design/" data-href="https://ant.design/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ant Design</a> for designing our user interface.</p><p name="c568" id="c568" class="graf graf--p graf-after--p">In the end of this tutorial series, you’ll have built a fully-fledged polling application from scratch <em class="markup--em markup--p-em">like a boss</em>.</p><blockquote name="954c" id="954c" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">The complete source code of the project is hosted on </em><a href="https://github.com/DimuthuKasunWP/spring-hibernate-security-react-ant-design-polling-app" data-href="https://github.com/DimuthuKasunWP/spring-hibernate-security-react-ant-design-polling-app" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank"><em class="markup--em markup--blockquote-em">Github</em></a><em class="markup--em markup--blockquote-em">. You can refer that anytime if you get stuck at something.</em></blockquote><p name="52e3" id="52e3" class="graf graf--p graf-after--blockquote">Following is the screenshot of the final version of our application -</p><figure name="ce32" id="ce32" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 363px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 51.800000000000004%;"></div><img class="graf-image" data-image-id="1*nzO5iTr1_Tso8Yhqz8pMrw.jpeg" data-width="1889" data-height="979" src="https://cdn-images-1.medium.com/max/800/1*nzO5iTr1_Tso8Yhqz8pMrw.jpeg"></div></figure><p name="2c83" id="2c83" class="graf graf--p graf-after--figure">Looks great, isn’t it? Well, then let’s start building it from scratch…</p><p name="6505" id="6505" class="graf graf--p graf-after--p">In this article, We’ll set up the backend project using Spring Boot and define the basic domain models and repositories.</p><h3 name="67b1" id="67b1" class="graf graf--h3 graf-after--p">Creating the Backend Application using Spring Boot</h3><p name="245d" id="245d" class="graf graf--p graf-after--h3">Let’s bootstrap the project using <a href="http://start.spring.io/" data-href="http://start.spring.io/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Spring Initialzr</a> web tool -</p><ol class="postList"><li name="992b" id="992b" class="graf graf--li graf-after--p">Open <a href="http://start.spring.io/" data-href="http://start.spring.io/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">http://start.spring.io</a></li><li name="3cef" id="3cef" class="graf graf--li graf-after--li">Enter polls in Artifact field.</li><li name="4fb4" id="4fb4" class="graf graf--li graf-after--li">Add Web, JPA, MySQL and Security dependencies from the Dependencies section.</li><li name="c340" id="c340" class="graf graf--li graf-after--li">Click Generate to generate and download the project.</li></ol><figure name="ee1c" id="ee1c" class="graf graf--figure graf-after--li"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 447px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 63.800000000000004%;"></div><img class="graf-image" data-image-id="1*BlC9GObH5ijPFLAYybjZAw.jpeg" data-width="1000" data-height="638" src="https://cdn-images-1.medium.com/max/800/1*BlC9GObH5ijPFLAYybjZAw.jpeg"></div></figure><p name="b6ed" id="b6ed" class="graf graf--p graf-after--figure">Once the project is downloaded, unzip it and import it into your favorite IDE. The directory structure of the project will look like this-</p><figure name="2fc5" id="2fc5" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 612px; max-height: 838px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 136.9%;"></div><img class="graf-image" data-image-id="0*oJL39pqZ3-jK0sAt.jpg" data-width="612" data-height="838" src="https://cdn-images-1.medium.com/max/800/0*oJL39pqZ3-jK0sAt.jpg"></div></figure><h3 name="b2e7" id="b2e7" class="graf graf--h3 graf-after--figure">Adding additional dependencies</h3><p name="b823" id="b823" class="graf graf--p graf-after--h3">We’ll need to add few additional dependencies to our project. Open <code class="markup--code markup--p-code">pom.xml</code> file from the root directory of your generated project and add the following to the <code class="markup--code markup--p-code">&lt;dependencies&gt;</code> section -</p><pre name="7fda" id="7fda" class="graf graf--pre graf-after--p">&lt;!-- For Working with Json Web Tokens (JWT) --&gt;<br>&lt;dependency&gt;<br>   &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;<br>   &lt;artifactId&gt;jjwt&lt;/artifactId&gt;<br>   &lt;version&gt;${jjwt.version}&lt;/version&gt;<br>&lt;/dependency&gt;<br><br>&lt;!-- For Java 8 Date/Time Support --&gt;<br>&lt;dependency&gt;<br>   &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt;<br>   &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt;<br>&lt;/dependency&gt;</pre><h3 name="a255" id="a255" class="graf graf--h3 graf-after--pre">Configuring the Server, Database, Hibernate and Jackson</h3><p name="3981" id="3981" class="graf graf--p graf-after--h3">Let’s now configure the server, database, hibernate, and jackson by adding the following properties to the <code class="markup--code markup--p-code">src/main/resources/application.properties</code> file -</p><pre name="4e71" id="4e71" class="graf graf--pre graf-after--p">## Server Properties<br>server.port= 8080<br>server.compression.enabled=true<br><br>## Spring DATASOURCE (DataSourceAutoConfiguration &amp; DataSourceProperties)<br>spring.datasource.url= jdbc:mysql://localhost:3306/polling_app?useSSL=false&amp;serverTimezone=UTC&amp;useLegacyDatetimeCode=false<br>spring.datasource.username= root<br>spring.datasource.password= 12345678<br><br><br>## Hibernate Properties<br># The SQL dialect makes Hibernate generate better SQL for the chosen database<br>spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5InnoDBDialect<br>spring.jpa.hibernate.ddl-auto = update<br><br>## Hibernate Logging<br>logging.level.org.hibernate.SQL= DEBUG<br><br># Initialize the datasource with available DDL and DML scripts<br>spring.datasource.initialization-mode=<em class="markup--em markup--pre-em">always<br><br></em>## Jackson Properties<br>spring.jackson.serialization.<em class="markup--em markup--pre-em">WRITE_DATES_AS_TIMESTAMPS</em>= false<br>spring.jackson.time-zone= UTC</pre><p name="34ff" id="34ff" class="graf graf--p graf-after--pre">All the above properties are self-explanatory. I’ve set hibernate’s <code class="markup--code markup--p-code">ddl-auto</code> property to <code class="markup--code markup--p-code">update</code>. This will automatically create/update the tables in the database according to the entities in our application.</p><p name="3c99" id="3c99" class="graf graf--p graf-after--p">The Jackson’s <code class="markup--code markup--p-code">WRITE_DATES_AS_TIMESTAMPS</code> property is used to disable serializing Java 8 Data/Time values as timestamps. All the Date/Time values will be serialized to ISO date/time string.</p><p name="c49d" id="c49d" class="graf graf--p graf-after--p">Before proceeding further, please create a database named <code class="markup--code markup--p-code">polling_app</code> in MySQL and change the <code class="markup--code markup--p-code">spring.datasource.username</code> and <code class="markup--code markup--p-code">spring.datasource.password</code> properties as per your MySQL installation.</p><h3 name="2f6e" id="2f6e" class="graf graf--h3 graf-after--p">Configuring Spring Boot to use Java 8 Date/Time converters and UTC Timezone</h3><p name="38c3" id="38c3" class="graf graf--p graf-after--h3">We’ll be using Java 8 Data/Time classes in our domain models. We’ll need to register JPA 2.1 converters so that all the Java 8 Date/Time fields in the domain models automatically get converted to SQL types when we persist them in the database.</p><p name="5fab" id="5fab" class="graf graf--p graf-after--p">Moreover, We’ll set the default timezone for our application to UTC.</p><p name="84ee" id="84ee" class="graf graf--p graf-after--p">Open the main class <code class="markup--code markup--p-code">PollsApplication.java</code> and make the following modifications to it-</p><pre name="3915" id="3915" class="graf graf--pre graf-after--p">package com.example.polls;<br><br>import org.springframework.boot.SpringApplication;<br>import org.springframework.boot.autoconfigure.SpringBootApplication;<br>import org.springframework.boot.autoconfigure.domain.EntityScan;<br>import org.springframework.data.jpa.convert.threeten.Jsr310JpaConverters;<br><br>import javax.annotation.PostConstruct;<br>import java.util.TimeZone;<br><br>@SpringBootApplication<br>@EntityScan(basePackageClasses = {<br>      PollsApplication.class,<br>      Jsr310JpaConverters.class<br>})<br>public class PollsApplication {<br><br>   @PostConstruct<br>   void init() {<br>      TimeZone.<em class="markup--em markup--pre-em">setDefault</em>(TimeZone.<em class="markup--em markup--pre-em">getTimeZone</em>(&quot;UTC&quot;));<br>   }<br><br>   public static void main(String[] args) {<br>      SpringApplication.<em class="markup--em markup--pre-em">run</em>(PollsApplication.class, args);<br>   }<br>}</pre><h3 name="bd1c" id="bd1c" class="graf graf--h3 graf-after--pre">Creating the domain models</h3><p name="4a43" id="4a43" class="graf graf--p graf-after--h3">Our application will allow new users to register and login to our application. Every User will have one or more roles. The roles associated with a user will be used in future to decide whether the user is authorized to access a particular resource on our server or not.</p><p name="32dc" id="32dc" class="graf graf--p graf-after--p">In this section, We’ll create the <code class="markup--code markup--p-code">User</code> and <code class="markup--code markup--p-code">Role</code> domain models. All the domain models will be stored in a package named <code class="markup--code markup--p-code">model</code> inside <code class="markup--code markup--p-code">com.example.polls</code>.</p><h3 name="919a" id="919a" class="graf graf--h3 graf-after--p">1. <code class="markup--code markup--h3-code">User</code> model</h3><p name="e886" id="e886" class="graf graf--p graf-after--h3">The <code class="markup--code markup--p-code">User</code> model contains the following fields -</p><ol class="postList"><li name="6f84" id="6f84" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">id</code>: Primary Key</li><li name="7f4a" id="7f4a" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">username</code>: A unique username</li><li name="1b79" id="1b79" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">email</code>: A unique email</li><li name="72e5" id="72e5" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">password</code>: A password which will be stored in encrypted format.</li><li name="0ebd" id="0ebd" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">roles</code>: A set of roles. (Many-To-Many relationship with <code class="markup--code markup--li-code">Role</code> entity)</li></ol><p name="1480" id="1480" class="graf graf--p graf-after--li">Here is the complete <code class="markup--code markup--p-code">User</code> class -</p><pre name="dfaa" id="dfaa" class="graf graf--pre graf-after--p">package com.example.polls.model;<br><br>import com.example.polls.model.audit.DateAudit;<br>import org.hibernate.annotations.NaturalId;<br>import javax.persistence.*;<br>import javax.validation.constraints.Email;<br>import javax.validation.constraints.NotBlank;<br>import javax.validation.constraints.Size;<br>import java.util.HashSet;<br>import java.util.Set;<br><br><em class="markup--em markup--pre-em">/**<br> * Created by DimuthuKasun on 01/05/20.<br> */<br><br></em>@Entity<br>@Table(name = &quot;users&quot;, uniqueConstraints = {<br>        @UniqueConstraint(columnNames = {<br>            &quot;username&quot;<br>        }),<br>        @UniqueConstraint(columnNames = {<br>            &quot;email&quot;<br>        })<br>})<br>public class User extends DateAudit {<br>    @Id<br>    @GeneratedValue(strategy = GenerationType.<em class="markup--em markup--pre-em">IDENTITY</em>)<br>    private Long id;<br><br>    @NotBlank<br>    @Size(max = 40)<br>    private String name;<br><br>    @NotBlank<br>    @Size(max = 15)<br>    private String username;<br><br>    @NaturalId<br>    @NotBlank<br>    @Size(max = 40)<br>    @Email<br>    private String email;<br><br>    @NotBlank<br>    @Size(max = 100)<br>    private String password;<br><br>    @ManyToMany(fetch = FetchType.<em class="markup--em markup--pre-em">LAZY</em>)<br>    @JoinTable(name = &quot;user_roles&quot;,<br>            joinColumns = @JoinColumn(name = &quot;user_id&quot;),<br>            inverseJoinColumns = @JoinColumn(name = &quot;role_id&quot;))<br>    private Set&lt;Role&gt; roles = new HashSet&lt;&gt;();<br><br>    public User() {<br><br>    }<br><br>    public User(String name, String username, String email, String password) {<br>        this.name = name;<br>        this.username = username;<br>        this.email = email;<br>        this.password = password;<br>    }<br><br>    public Long getId() {<br>        return id;<br>    }<br><br>    public void setId(Long id) {<br>        this.id = id;<br>    }<br><br>    public String getUsername() {<br>        return username;<br>    }<br><br>    public void setUsername(String username) {<br>        this.username = username;<br>    }<br><br>    public String getName() {<br>        return name;<br>    }<br><br>    public void setName(String name) {<br>        this.name = name;<br>    }<br><br>    public String getEmail() {<br>        return email;<br>    }<br><br>    public void setEmail(String email) {<br>        this.email = email;<br>    }<br><br>    public String getPassword() {<br>        return password;<br>    }<br><br>    public void setPassword(String password) {<br>        this.password = password;<br>    }<br><br>    public Set&lt;Role&gt; getRoles() {<br>        return roles;<br>    }<br><br>    public void setRoles(Set&lt;Role&gt; roles) {<br>        this.roles = roles;<br>    }<br>}</pre><p name="685f" id="685f" class="graf graf--p graf-after--pre">The <code class="markup--code markup--p-code">User</code> class extends the <code class="markup--code markup--p-code">DateAudit</code> class that we’ll define shortly. The <code class="markup--code markup--p-code">DateAudit</code> class will have <code class="markup--code markup--p-code">createdAt</code> and <code class="markup--code markup--p-code">updatedAt</code> fields that will be used for auditing purposes.</p><h3 name="a3dd" id="a3dd" class="graf graf--h3 graf-after--p">2. <code class="markup--code markup--h3-code">Role</code> model</h3><p name="c4e3" id="c4e3" class="graf graf--p graf-after--h3">The <code class="markup--code markup--p-code">Role</code> class contains an <code class="markup--code markup--p-code">id</code> and a <code class="markup--code markup--p-code">name</code> field. The <code class="markup--code markup--p-code">name</code> field is an <code class="markup--code markup--p-code">enum</code>. We’ll have a fixed set of pre-defined roles. So it makes sense to make the role name as <code class="markup--code markup--p-code">enum</code>.</p><p name="a80e" id="a80e" class="graf graf--p graf-after--p">Here is the complete code for <code class="markup--code markup--p-code">Role</code> class -</p><pre name="7e61" id="7e61" class="graf graf--pre graf-after--p">package com.example.polls.model;<br><br>import org.hibernate.annotations.NaturalId;<br>import javax.persistence.*;<br><br><em class="markup--em markup--pre-em">/**<br> * Created by DimuthuKasun on 01/05/20.<br> */<br></em>@Entity<br>@Table(name = &quot;roles&quot;)<br>public class Role {<br>    @Id<br>    @GeneratedValue(strategy = GenerationType.<em class="markup--em markup--pre-em">IDENTITY</em>)<br>    private Long id;<br><br>    @Enumerated(EnumType.<em class="markup--em markup--pre-em">STRING</em>)<br>    @NaturalId<br>    @Column(length = 60)<br>    private RoleName name;<br><br>    public Role() {<br><br>    }<br><br>    public Role(RoleName name) {<br>        this.name = name;<br>    }<br><br>    public Long getId() {<br>        return id;<br>    }<br><br>    public void setId(Long id) {<br>        this.id = id;<br>    }<br><br>    public RoleName getName() {<br>        return name;<br>    }<br><br>    public void setName(RoleName name) {<br>        this.name = name;<br>    }<br><br>}</pre><p name="af25" id="af25" class="graf graf--p graf-after--pre">I have defined two roles namely <code class="markup--code markup--p-code">ROLE_USER</code> and <code class="markup--code markup--p-code">ROLE_ADMIN</code>. You’re free to add more roles as per your project requirements.</p><h3 name="fbe1" id="fbe1" class="graf graf--h3 graf-after--p">3. <code class="markup--code markup--h3-code">DateAudit</code> model</h3><p name="ca85" id="ca85" class="graf graf--p graf-after--h3">All right! Let’s now define the <code class="markup--code markup--p-code">DateAudit</code> model. It will have a <code class="markup--code markup--p-code">createdAt</code> and an <code class="markup--code markup--p-code">updatedAt</code> field. Other domain models that need these auditing fields will simply extend this class.</p><p name="e8e0" id="e8e0" class="graf graf--p graf-after--p">We’ll use JPA’s <code class="markup--code markup--p-code">AuditingEntityListener</code> to automatically populate <code class="markup--code markup--p-code">createdAt</code> and <code class="markup--code markup--p-code">updatedAt</code> values when we persist an entity.</p><p name="b116" id="b116" class="graf graf--p graf-after--p">Here is the Complete <code class="markup--code markup--p-code">DateAudit</code> class (I’ve created a package named <code class="markup--code markup--p-code">audit</code> inside <code class="markup--code markup--p-code">com.example.polls.model</code> package to store all the auditing related models) -</p><pre name="c16c" id="c16c" class="graf graf--pre graf-after--p">package com.example.polls.model.audit;<br><br>import com.fasterxml.jackson.annotation.JsonIgnoreProperties;<br>import org.springframework.data.annotation.CreatedDate;<br>import org.springframework.data.annotation.LastModifiedDate;<br>import org.springframework.data.jpa.domain.support.AuditingEntityListener;<br><br>import javax.persistence.EntityListeners;<br>import javax.persistence.MappedSuperclass;<br>import java.io.Serializable;<br>import java.time.Instant;<br><br>@MappedSuperclass<br>@EntityListeners(AuditingEntityListener.class)<br>@JsonIgnoreProperties(<br>        value = {&quot;createdAt&quot;, &quot;updatedAt&quot;},<br>        allowGetters = true<br>)<br>public abstract class DateAudit implements Serializable {<br><br>    @CreatedDate<br>    private Instant createdAt;<br><br>    @LastModifiedDate<br>    private Instant updatedAt;<br><br>    public Instant getCreatedAt() {<br>        return createdAt;<br>    }<br><br>    public void setCreatedAt(Instant createdAt) {<br>        this.createdAt = createdAt;<br>    }<br><br>    public Instant getUpdatedAt() {<br>        return updatedAt;<br>    }<br><br>    public void setUpdatedAt(Instant updatedAt) {<br>        this.updatedAt = updatedAt;<br>    }<br><br>}</pre><p name="f957" id="f957" class="graf graf--p graf-after--pre">To enable JPA Auditing, we’ll need to add <code class="markup--code markup--p-code">@EnableJpaAuditing</code> annotation to our main class or any other configuration classes.</p><p name="f091" id="f091" class="graf graf--p graf-after--p">Let’s create an <code class="markup--code markup--p-code">AuditingConfig</code> configuration class and add the <code class="markup--code markup--p-code">@EnableJpaAuditing</code> annotation to it.</p><p name="de8f" id="de8f" class="graf graf--p graf-after--p">We’re creating a separate class because we’ll be adding more auditing related configurations later. So it’s better to have a separate class.</p><p name="6989" id="6989" class="graf graf--p graf-after--p">We’ll keep all the configuration classes inside a package named <code class="markup--code markup--p-code">config</code>. Go ahead and create the <code class="markup--code markup--p-code">config</code> package inside <code class="markup--code markup--p-code">com.example.polls</code>, and then create the <code class="markup--code markup--p-code">AuditingConfig</code> class inside <code class="markup--code markup--p-code">config</code> package -</p><pre name="e28d" id="e28d" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.config;<br><br>import org.springframework.context.annotation.Configuration;<br>import org.springframework.data.jpa.repository.config.EnableJpaAuditing;</code></pre><pre name="db7a" id="db7a" class="graf graf--pre graf-after--pre">@Configuration<br>@EnableJpaAuditing<br>public class AuditingConfig {<br><br>  <code class="markup--code markup--pre-code"> // That&#39;s all here for now. We&#39;ll add more auditing configurations later.</code><br>}</pre><h3 name="c8ef" id="c8ef" class="graf graf--h3 graf-after--pre">Creating the Repositories for accessing <code class="markup--code markup--h3-code">User</code> and <code class="markup--code markup--h3-code">Role</code> data</h3><p name="d965" id="d965" class="graf graf--p graf-after--h3">Now that we have defined the domain models, Let’s create the repositories for persisting these domain models to the database and retrieving them.</p><p name="aa61" id="aa61" class="graf graf--p graf-after--p">All the repositories will go inside a package named <code class="markup--code markup--p-code">repository</code>. So let’s first create the <code class="markup--code markup--p-code">repository</code> package inside <code class="markup--code markup--p-code">com.example.polls</code>.</p><h3 name="f38e" id="f38e" class="graf graf--h3 graf-after--p">1. <code class="markup--code markup--h3-code">UserRepository</code></h3><p name="88fc" id="88fc" class="graf graf--p graf-after--h3">Following is the complete code for <code class="markup--code markup--p-code">UserRepository</code> interface. It extends Spring Data JPA’s <code class="markup--code markup--p-code">JpaRepository</code> interface.</p><pre name="0ac6" id="0ac6" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.repository;<br><br>import com.example.polls.model.User;<br>import org.springframework.data.jpa.repository.JpaRepository;<br>import org.springframework.stereotype.Repository;<br>import java.util.List;<br>import java.util.Optional;<br><br>@Repository<br>public interface UserRepository extends JpaRepository&lt;User, Long&gt; {<br>    Optional&lt;User&gt; findByEmail(String email);<br><br>    Optional&lt;User&gt; findByUsernameOrEmail(String username, String email);<br><br>    List&lt;User&gt; findByIdIn(List&lt;Long&gt; userIds);<br><br>    Optional&lt;User&gt; findByUsername(String username);<br><br>    Boolean existsByUsername(String username);<br><br>    Boolean existsByEmail(String email);<br>}</code></pre><h3 name="f853" id="f853" class="graf graf--h3 graf-after--pre">2. <code class="markup--code markup--h3-code">RoleRepository</code></h3><p name="a399" id="a399" class="graf graf--p graf-after--h3">Following is the <code class="markup--code markup--p-code">RoleRepository</code> interface. It contains a single method to retrieve a <code class="markup--code markup--p-code">Role</code> from the <code class="markup--code markup--p-code">RoleName</code>-</p><pre name="291a" id="291a" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.repository;</code></pre><pre name="2c05" id="2c05" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.Role;<br>import com.example.polls.model.RoleName;<br>import org.springframework.data.jpa.repository.JpaRepository;<br>import org.springframework.stereotype.Repository;<br>import java.util.Optional;</code></pre><pre name="f732" id="f732" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Repository<br>public interface RoleRepository extends JpaRepository&lt;Role, Long&gt; {<br>    Optional&lt;Role&gt; findByName(RoleName roleName);<br>}</code></pre><h3 name="a5b1" id="a5b1" class="graf graf--h3 graf-after--pre">Exploring the current setup and Running the Application</h3><p name="7c46" id="7c46" class="graf graf--p graf-after--h3">After creating all the above models, repositories and configurations, our current project should look like this -</p><figure name="0e15" id="0e15" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 933px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 133.29999999999998%;"></div><img class="graf-image" data-image-id="0*-L_qQxaZtLrYsWmD.jpg" data-width="912" data-height="1216" src="https://cdn-images-1.medium.com/max/800/0*-L_qQxaZtLrYsWmD.jpg"></div></figure><p name="a964" id="a964" class="graf graf--p graf-after--figure">You can run the application by typing the following command from the root directory of your project -</p><pre name="3a64" id="3a64" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">mvn spring-boot:run</code></pre><p name="43fc" id="43fc" class="graf graf--p graf-after--pre">Check out the logs and make sure that the server starts successfully.</p><pre name="ec22" id="ec22" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">2018-02-24 22:40:44.998  INFO 33708 --- Tomcat started on port(s): 5000 (http)<br>2018-02-24 22:40:45.008  INFO 33708 --- Started PollsApplication in 7.804 seconds (JVM running for 27.193)</code></pre><p name="9b07" id="9b07" class="graf graf--p graf-after--pre">Write to me in the discussion section, if the server doesn’t start successfully for you. I’ll help you out.</p><h3 name="11dc" id="11dc" class="graf graf--h3 graf-after--p">Creating Default Roles</h3><p name="5dcc" id="5dcc" class="graf graf--p graf-after--h3">We’ll have a fixed set of predefined roles in our application. Whenever a user logs in, we’ll assign <code class="markup--code markup--p-code">ROLE_USER</code> to it by default.</p><p name="369b" id="369b" class="graf graf--p graf-after--p">For assigning the roles, they have to be present in the database. So let’s create the two default roles in the database by executing the following insert statements -</p><pre name="5552" id="5552" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">INSERT INTO roles(name) VALUES(&#39;ROLE_USER&#39;);<br>INSERT INTO roles(name) VALUES(&#39;ROLE_ADMIN&#39;);</code></pre><p name="b4f6" id="b4f6" class="graf graf--p graf-after--pre">Then, We’ll configure Spring Security along with JWT authentication, and write the APIs to let users register and login to our application.</p><figure name="98ec" id="98ec" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 318px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 45.4%;"></div><img class="graf-image" data-image-id="1*VCGnIVj_4Iakp_aMYbe-eg.jpeg" data-width="1794" data-height="814" src="https://cdn-images-1.medium.com/max/800/1*VCGnIVj_4Iakp_aMYbe-eg.jpeg"></div></figure><h3 name="c59f" id="c59f" class="graf graf--h3 graf-after--figure">An overview of the security mechanism that we’re going to build</h3><ul class="postList"><li name="7ca0" id="7ca0" class="graf graf--li graf-after--h3">Build an API that registers new users with their name, username, email and password.</li><li name="7fb4" id="7fb4" class="graf graf--li graf-after--li">Build an API to let users log in using their username/email and password. After validating user’s credentials, the API should generate a JWT authentication token and return the token in the response.</li><li name="57c8" id="57c8" class="graf graf--li graf-after--li">The clients will send this JWT token in the <code class="markup--code markup--li-code">Authorization</code> header of all the requests to access any protected resources.</li><li name="ed3d" id="ed3d" class="graf graf--li graf-after--li">Configure Spring security to restrict access to protected resources. For example,</li><li name="6116" id="6116" class="graf graf--li graf-after--li">APIs for login, signup, and any static resources like images, scripts and stylesheets should be accessible to everyone.</li><li name="811c" id="811c" class="graf graf--li graf-after--li">APIs to create a poll, vote to a poll etc, should be accessible to authenticated users only.</li><li name="6b36" id="6b36" class="graf graf--li graf-after--li">Configure Spring security to throw a 401 unauthorized error if a client tries to access a protected resource without a valid JWT token.</li></ul><h3 name="0d68" id="0d68" class="graf graf--h3 graf-after--li">Configuring Spring Security and JWT</h3><p name="4d44" id="4d44" class="graf graf--p graf-after--h3">The following class is the crux of our security implementation. It contains almost all the security configurations that are required for our project.</p><p name="ac2d" id="ac2d" class="graf graf--p graf-after--p">Let’s first create the following <code class="markup--code markup--p-code">SecurityConfig</code> class inside the package <code class="markup--code markup--p-code">com.example.polls.config</code>, and then we’ll go through the code and learn what each configuration does -</p><pre name="2bfb" id="2bfb" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.config;</code></pre><pre name="043c" id="043c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.security.CustomUserDetailsService;<br>import com.example.polls.security.JwtAuthenticationEntryPoint;<br>import com.example.polls.security.JwtAuthenticationFilter;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.context.annotation.Bean;<br>import org.springframework.context.annotation.Configuration;<br>import org.springframework.http.HttpMethod;<br>import org.springframework.security.authentication.AuthenticationManager;<br>import org.springframework.security.config.BeanIds;<br>import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br>import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;<br>import org.springframework.security.config.annotation.web.builders.HttpSecurity;<br>import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;<br>import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br>import org.springframework.security.config.http.SessionCreationPolicy;<br>import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;<br>import org.springframework.security.crypto.password.PasswordEncoder;<br>import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</code></pre><pre name="c907" id="c907" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Configuration<br>@EnableWebSecurity<br>@EnableGlobalMethodSecurity(<br>        securedEnabled = true,<br>        jsr250Enabled = true,<br>        prePostEnabled = true<br>)<br>public class SecurityConfig extends WebSecurityConfigurerAdapter {<br>    @Autowired<br>    CustomUserDetailsService customUserDetailsService;</code></pre><pre name="51ca" id="51ca" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    private JwtAuthenticationEntryPoint unauthorizedHandler;</code></pre><pre name="e781" id="e781" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Bean<br>    public JwtAuthenticationFilter jwtAuthenticationFilter() {<br>        return new JwtAuthenticationFilter();<br>    }</code></pre><pre name="c3bb" id="c3bb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public void configure(AuthenticationManagerBuilder authenticationManagerBuilder) throws Exception {<br>        authenticationManagerBuilder<br>                .userDetailsService(customUserDetailsService)<br>                .passwordEncoder(passwordEncoder());<br>    }</code></pre><pre name="c905" id="c905" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Bean(BeanIds.AUTHENTICATION_MANAGER)<br>    @Override<br>    public AuthenticationManager authenticationManagerBean() throws Exception {<br>        return super.authenticationManagerBean();<br>    }</code></pre><pre name="c745" id="c745" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Bean<br>    public PasswordEncoder passwordEncoder() {<br>        return new BCryptPasswordEncoder();<br>    }</code></pre><pre name="bdbe" id="bdbe" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    protected void configure(HttpSecurity http) throws Exception {<br>        http<br>                .cors()<br>                    .and()<br>                .csrf()<br>                    .disable()<br>                .exceptionHandling()<br>                    .authenticationEntryPoint(unauthorizedHandler)<br>                    .and()<br>                .sessionManagement()<br>                    .sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br>                    .and()<br>                .authorizeRequests()<br>                    .antMatchers(&quot;/&quot;,<br>                        &quot;/favicon.ico&quot;,<br>                        &quot;/**/*.png&quot;,<br>                        &quot;/**/*.gif&quot;,<br>                        &quot;/**/*.svg&quot;,<br>                        &quot;/**/*.jpg&quot;,<br>                        &quot;/**/*.html&quot;,<br>                        &quot;/**/*.css&quot;,<br>                        &quot;/**/*.js&quot;)<br>                        .permitAll()<br>                    .antMatchers(&quot;/api/auth/**&quot;)<br>                        .permitAll()<br>                    .antMatchers(&quot;/api/user/checkUsernameAvailability&quot;, &quot;/api/user/checkEmailAvailability&quot;)<br>                        .permitAll()<br>                    .antMatchers(HttpMethod.GET, &quot;/api/polls/**&quot;, &quot;/api/users/**&quot;)<br>                        .permitAll()<br>                    .anyRequest()<br>                        .authenticated();</code></pre><pre name="2261" id="2261" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Add our custom JWT security filter<br>        http.addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);</code></pre><pre name="def9" id="def9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    }<br>}</code></pre><p name="a179" id="a179" class="graf graf--p graf-after--pre">The above <code class="markup--code markup--p-code">SecurityConfig</code> class will show compilation errors in your IDE because we haven’t yet defined many of the classes that are being used in it. We will define them one by one in this article.</p><p name="d51b" id="d51b" class="graf graf--p graf-after--p">But before that, Let’s understand the meaning of the annotations and configurations used in the <code class="markup--code markup--p-code">SecurityConfig</code> class -</p><h4 name="2003" id="2003" class="graf graf--h4 graf-after--p">1. @EnableWebSecurity</h4><p name="d47f" id="d47f" class="graf graf--p graf-after--h4">This is the primary spring security annotation that is used to enable web security in a project.</p><h4 name="a18e" id="a18e" class="graf graf--h4 graf-after--p">2. @EnableGlobalMethodSecurity</h4><p name="de1c" id="de1c" class="graf graf--p graf-after--h4">This is used to enable method level security based on annotations. You can use following three types of annotations for securing your methods -</p><ul class="postList"><li name="8753" id="8753" class="graf graf--li graf-after--p">securedEnabled: It enables the <code class="markup--code markup--li-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/access/annotation/Secured.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/access/annotation/Secured.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">@Secured</a></code> annotation using which you can protect your controller/service methods like so -</li></ul><p name="b60e" id="b60e" class="graf graf--p graf-after--li"><code class="markup--code markup--p-code">@Secured(&quot;ROLE_ADMIN&quot;) public User getAllUsers() {} @Secured({&quot;ROLE_USER&quot;, &quot;ROLE_ADMIN&quot;}) public User getUser(Long id) {} @Secured(&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;) public boolean isUsernameAvailable() {}</code></p><ul class="postList"><li name="60db" id="60db" class="graf graf--li graf-after--p">jsr250Enabled: It enables the <code class="markup--code markup--li-code">@RolesAllowed</code> annotation that can be used like this -</li></ul><p name="7040" id="7040" class="graf graf--p graf-after--li"><code class="markup--code markup--p-code">@RolesAllowed(&quot;ROLE_ADMIN&quot;) public Poll createPoll() {}</code></p><ul class="postList"><li name="86bf" id="86bf" class="graf graf--li graf-after--p">prePostEnabled: It enables more complex expression based access control syntax with <code class="markup--code markup--li-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/reference/htmlsingle/#access-control-using-preauthorize-and-postauthorize" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/reference/htmlsingle/#access-control-using-preauthorize-and-postauthorize" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">@PreAuthorize</a></code> and <code class="markup--code markup--li-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/reference/htmlsingle/#access-control-using-preauthorize-and-postauthorize" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/reference/htmlsingle/#access-control-using-preauthorize-and-postauthorize" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">@PostAuthorize</a></code> annotations -</li></ul><p name="9cff" id="9cff" class="graf graf--p graf-after--li"><code class="markup--code markup--p-code">@PreAuthorize(&quot;isAnonymous()&quot;) public boolean isUsernameAvailable() {} @PreAuthorize(&quot;hasRole(&#39;USER&#39;)&quot;) public Poll createPoll() {}</code></p><h4 name="3d8d" id="3d8d" class="graf graf--h4 graf-after--p">3. WebSecurityConfigurerAdapter</h4><p name="e724" id="e724" class="graf graf--p graf-after--h4">This class implements Spring Security’s <code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">WebSecurityConfigurer</a></code> interface. It provides default security configurations and allows other classes to extend it and customize the security configurations by overriding its methods.</p><p name="4f2c" id="4f2c" class="graf graf--p graf-after--p">Our <code class="markup--code markup--p-code">SecurityConfig</code> class extends <code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/config/annotation/web/configuration/WebSecurityConfigurerAdapter.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">WebSecurityConfigurerAdapter</a></code> and overrides some of its methods to provide custom security configurations.</p><h4 name="c46d" id="c46d" class="graf graf--h4 graf-after--p">4. CustomUserDetailsService</h4><p name="f92b" id="f92b" class="graf graf--p graf-after--h4">To authenticate a User or perform various role-based checks, Spring security needs to load users details somehow.</p><p name="87d2" id="87d2" class="graf graf--p graf-after--p">For this purpose, It consists of an interface called <code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/core/userdetails/UserDetailsService.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/core/userdetails/UserDetailsService.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">UserDetailsService</a></code> which has a single method that loads a user based on username-</p><pre name="a3ff" id="a3ff" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;</code></pre><p name="f962" id="f962" class="graf graf--p graf-after--pre">We’ll define a <code class="markup--code markup--p-code">CustomUserDetailsService</code> that implements <code class="markup--code markup--p-code">UserDetailsService</code> interface and provides the implementation for <code class="markup--code markup--p-code">loadUserByUsername()</code> method.</p><p name="1e18" id="1e18" class="graf graf--p graf-after--p">Note that, the <code class="markup--code markup--p-code">loadUserByUsername()</code> method returns a <code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/core/userdetails/UserDetails.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/core/userdetails/UserDetails.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">UserDetails</a></code> object that Spring Security uses for performing various authentication and role based validations.</p><p name="b9d1" id="b9d1" class="graf graf--p graf-after--p">In our implementation, We’ll also define a custom <code class="markup--code markup--p-code">UserPrincipal</code> class that will implement <code class="markup--code markup--p-code">UserDetails</code> interface, and return the <code class="markup--code markup--p-code">UserPrincipal</code> object from <code class="markup--code markup--p-code">loadUserByUsername()</code> method.</p><h4 name="8f68" id="8f68" class="graf graf--h4 graf-after--p">5. JwtAuthenticationEntryPoint</h4><p name="e81f" id="e81f" class="graf graf--p graf-after--h4">This class is used to return a 401 unauthorized error to clients that try to access a protected resource without proper authentication. It implements Spring Security’s <code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/web/AuthenticationEntryPoint.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/web/AuthenticationEntryPoint.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AuthenticationEntryPoint</a></code> interface.</p><h4 name="42e5" id="42e5" class="graf graf--h4 graf-after--p">6. JwtAuthenticationFilter</h4><p name="4bd5" id="4bd5" class="graf graf--p graf-after--h4">We’ll use <code class="markup--code markup--p-code">JWTAuthenticationFilter</code> to implement a filter that -</p><ul class="postList"><li name="8966" id="8966" class="graf graf--li graf-after--p">reads JWT authentication token from the <code class="markup--code markup--li-code">Authorization</code> header of all the requests</li><li name="c54c" id="c54c" class="graf graf--li graf-after--li">validates the token</li><li name="811d" id="811d" class="graf graf--li graf-after--li">loads the user details associated with that token.</li><li name="079d" id="079d" class="graf graf--li graf-after--li">Sets the user details in Spring Security’s <code class="markup--code markup--li-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/core/context/SecurityContext.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/core/context/SecurityContext.html" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">SecurityContext</a></code>. Spring Security uses the user details to perform authorization checks. We can also access the user details stored in the <code class="markup--code markup--li-code">SecurityContext</code> in our controllers to perform our business logic.</li></ul><h4 name="91de" id="91de" class="graf graf--h4 graf-after--li">7. AuthenticationManagerBuilder and AuthenticationManager</h4><p name="062f" id="062f" class="graf graf--p graf-after--h4"><code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/config/annotation/authentication/builders/AuthenticationManagerBuilder.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/config/annotation/authentication/builders/AuthenticationManagerBuilder.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AuthenticationManagerBuilder</a></code> is used to create an <code class="markup--code markup--p-code"><a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/authentication/AuthenticationManager.html" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/api/org/springframework/security/authentication/AuthenticationManager.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">AuthenticationManager</a></code> instance which is the main Spring Security interface for authenticating a user.</p><p name="bdf1" id="bdf1" class="graf graf--p graf-after--p">You can use <code class="markup--code markup--p-code">AuthenticationManagerBuilder</code> to build in-memory authentication, LDAP authentication, JDBC authentication, or add your custom authentication provider.</p><p name="7ee9" id="7ee9" class="graf graf--p graf-after--p">In our example, we’ve provided our customUserDetailsService and a passwordEncoder to build the AuthenticationManager.</p><p name="8016" id="8016" class="graf graf--p graf-after--p">We’ll use the configured <code class="markup--code markup--p-code">AuthenticationManager</code> to authenticate a user in the login API.</p><h4 name="328c" id="328c" class="graf graf--h4 graf-after--p">8. HttpSecurity configurations</h4><p name="c825" id="c825" class="graf graf--p graf-after--h4">The <a href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/reference/htmlsingle/#jc-httpsecurity" data-href="https://docs.spring.io/spring-security/site/docs/5.0.2.RELEASE/reference/htmlsingle/#jc-httpsecurity" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">HttpSecurity</a> configurations are used to configure security functionalities like <code class="markup--code markup--p-code">csrf</code>, <code class="markup--code markup--p-code">sessionManagement</code>, and add rules to protect resources based on various conditions.</p><p name="8799" id="8799" class="graf graf--p graf-after--p">In our example, we’re permitting access to static resources and few other public APIs to everyone and restricting access to other APIs to authenticated users only.</p><p name="af32" id="af32" class="graf graf--p graf-after--p">We’ve also added the <code class="markup--code markup--p-code">JWTAuthenticationEntryPoint</code> and the custom <code class="markup--code markup--p-code">JWTAuthenticationFilter</code> in the <code class="markup--code markup--p-code">HttpSecurity</code> configuration.</p><h3 name="41bf" id="41bf" class="graf graf--h3 graf-after--p">Creating Custom Spring Security Classes, Filters, and Annotations</h3><p name="345a" id="345a" class="graf graf--p graf-after--h3">In the previous section, we configured spring security with many custom classes and filters. In this section, we’ll define those classes one by one.</p><p name="96e9" id="96e9" class="graf graf--p graf-after--p">All the following custom security related classes will go inside a package named <code class="markup--code markup--p-code">com.example.poll.security</code>.</p><h3 name="5c85" id="5c85" class="graf graf--h3 graf-after--p">1. Custom Spring Security AuthenticationEntryPoint</h3><p name="ddc2" id="ddc2" class="graf graf--p graf-after--h3">The first spring security related class that we’ll define is <code class="markup--code markup--p-code">JwtAuthenticationEntryPoint</code>. It implements <code class="markup--code markup--p-code">AuthenticationEntryPoint</code> interface and provides the implementation for its <code class="markup--code markup--p-code">commence()</code> method. This method is called whenever an exception is thrown due to an unauthenticated user trying to access a resource that requires authentication.</p><p name="7804" id="7804" class="graf graf--p graf-after--p">In this case, we’ll simply respond with a 401 error containing the exception message.</p><pre name="8e25" id="8e25" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.security;<br><br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.security.core.AuthenticationException;<br>import org.springframework.security.web.AuthenticationEntryPoint;<br>import org.springframework.stereotype.Component;<br><br>import javax.servlet.ServletException;<br>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;<br>import java.io.IOException;<br><br>@Component<br>public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint {<br><br>    private static final Logger logger = LoggerFactory.getLogger(JwtAuthenticationEntryPoint.class);<br>    @Override<br>    public void commence(HttpServletRequest httpServletRequest,<br>                         HttpServletResponse httpServletResponse,<br>                         AuthenticationException e) throws IOException, ServletException {<br>        logger.error(&quot;Responding with unauthorized error. Message - {}&quot;, e.getMessage());<br>        httpServletResponse.sendError(HttpServletResponse.SC_UNAUTHORIZED, e.getMessage());<br>    }<br>}</code></pre><h3 name="27fb" id="27fb" class="graf graf--h3 graf-after--pre">2. Custom Spring Security UserDetails</h3><p name="82da" id="82da" class="graf graf--p graf-after--h3">Next, Let’s define our custom <code class="markup--code markup--p-code">UserDetails</code> class called <code class="markup--code markup--p-code">UserPrincipal</code>. This is the class whose instances will be returned from our custom <code class="markup--code markup--p-code">UserDetailsService</code>. Spring Security will use the information stored in the <code class="markup--code markup--p-code">UserPrincipal</code> object to perform authentication and authorization.</p><p name="ccdd" id="ccdd" class="graf graf--p graf-after--p">Here is the complete <code class="markup--code markup--p-code">UserPrincipal</code> class -</p><pre name="5747" id="5747" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.security;</code></pre><pre name="8f28" id="8f28" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.User;<br>import com.fasterxml.jackson.annotation.JsonIgnore;<br>import org.springframework.security.core.GrantedAuthority;<br>import org.springframework.security.core.authority.SimpleGrantedAuthority;<br>import org.springframework.security.core.userdetails.UserDetails;</code></pre><pre name="fd5c" id="fd5c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import java.util.Collection;<br>import java.util.List;<br>import java.util.Objects;<br>import java.util.stream.Collectors;</code></pre><pre name="e001" id="e001" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class UserPrincipal implements UserDetails {<br>    private Long id;</code></pre><pre name="05f8" id="05f8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private String name;</code></pre><pre name="031d" id="031d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private String username;</code></pre><pre name="5669" id="5669" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @JsonIgnore<br>    private String email;</code></pre><pre name="3bb8" id="3bb8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @JsonIgnore<br>    private String password;</code></pre><pre name="dd7e" id="dd7e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private Collection&lt;? extends GrantedAuthority&gt; authorities;</code></pre><pre name="d2de" id="d2de" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public UserPrincipal(Long id, String name, String username, String email, String password, Collection&lt;? extends GrantedAuthority&gt; authorities) {<br>        this.id = id;<br>        this.name = name;<br>        this.username = username;<br>        this.email = email;<br>        this.password = password;<br>        this.authorities = authorities;<br>    }</code></pre><pre name="b4ff" id="b4ff" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public static UserPrincipal create(User user) {<br>        List&lt;GrantedAuthority&gt; authorities = user.getRoles().stream().map(role -&gt;<br>                new SimpleGrantedAuthority(role.getName().name())<br>        ).collect(Collectors.toList());</code></pre><pre name="426e" id="426e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return new UserPrincipal(<br>                user.getId(),<br>                user.getName(),<br>                user.getUsername(),<br>                user.getEmail(),<br>                user.getPassword(),<br>                authorities<br>        );<br>    }</code></pre><pre name="342b" id="342b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="cdc6" id="cdc6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getName() {<br>        return name;<br>    }</code></pre><pre name="00be" id="00be" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getEmail() {<br>        return email;<br>    }</code></pre><pre name="884d" id="884d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public String getUsername() {<br>        return username;<br>    }</code></pre><pre name="3280" id="3280" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public String getPassword() {<br>        return password;<br>    }</code></pre><pre name="5f58" id="5f58" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {<br>        return authorities;<br>    }</code></pre><pre name="d45f" id="d45f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public boolean isAccountNonExpired() {<br>        return true;<br>    }</code></pre><pre name="c836" id="c836" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public boolean isAccountNonLocked() {<br>        return true;<br>    }</code></pre><pre name="793f" id="793f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public boolean isCredentialsNonExpired() {<br>        return true;<br>    }</code></pre><pre name="f9c8" id="f9c8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public boolean isEnabled() {<br>        return true;<br>    }</code></pre><pre name="04d5" id="04d5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public boolean equals(Object o) {<br>        if (this == o) return true;<br>        if (o == null || getClass() != o.getClass()) return false;<br>        UserPrincipal that = (UserPrincipal) o;<br>        return Objects.equals(id, that.id);<br>    }</code></pre><pre name="9756" id="9756" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public int hashCode() {</code></pre><pre name="6efe" id="6efe" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return Objects.hash(id);<br>    }<br>}</code></pre><h3 name="a415" id="a415" class="graf graf--h3 graf-after--pre">3. Custom Spring Security UserDetailsService</h3><p name="6f88" id="6f88" class="graf graf--p graf-after--h3">Now let’s define the custom <code class="markup--code markup--p-code">UserDetailsService</code> which loads a user’s data given its username -</p><pre name="9286" id="9286" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.security;</code></pre><pre name="25a0" id="25a0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.User;<br>import com.example.polls.repository.UserRepository;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.security.core.userdetails.UserDetails;<br>import org.springframework.security.core.userdetails.UserDetailsService;<br>import org.springframework.security.core.userdetails.UsernameNotFoundException;<br>import org.springframework.stereotype.Service;<br>import org.springframework.transaction.annotation.Transactional;</code></pre><pre name="f345" id="f345" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Service<br>public class CustomUserDetailsService implements UserDetailsService {</code></pre><pre name="617e" id="617e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    UserRepository userRepository;</code></pre><pre name="c637" id="c637" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    @Transactional<br>    public UserDetails loadUserByUsername(String usernameOrEmail)<br>            throws UsernameNotFoundException {<br>        // Let people login with either username or email<br>        User user = userRepository.findByUsernameOrEmail(usernameOrEmail, usernameOrEmail)<br>                .orElseThrow(() -&gt; <br>                        new UsernameNotFoundException(&quot;User not found with username or email : &quot; + usernameOrEmail)<br>        );</code></pre><pre name="3bce" id="3bce" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return UserPrincipal.create(user);<br>    }</code></pre><pre name="4030" id="4030" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    // This method is used by JWTAuthenticationFilter<br>    @Transactional<br>    public UserDetails loadUserById(Long id) {<br>        User user = userRepository.findById(id).orElseThrow(<br>            () -&gt; new UsernameNotFoundException(&quot;User not found with id : &quot; + id)<br>        );</code></pre><pre name="6ba9" id="6ba9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return UserPrincipal.create(user);<br>    }<br>}</code></pre><p name="6748" id="6748" class="graf graf--p graf-after--pre">The first method <code class="markup--code markup--p-code">loadUserByUsername()</code> is used by Spring security. Notice the use of <code class="markup--code markup--p-code">findByUsernameOrEmail</code> method. This allows users to log in using either username or email.</p><p name="76a4" id="76a4" class="graf graf--p graf-after--p">The second method <code class="markup--code markup--p-code">loadUserById()</code> will be used by <code class="markup--code markup--p-code">JWTAuthenticationFilter</code> that we’ll define shortly.</p><h3 name="f863" id="f863" class="graf graf--h3 graf-after--p">4. Utility class for generating and verifying JWT</h3><p name="5f64" id="5f64" class="graf graf--p graf-after--h3">The following utility class will be used for generating a JWT after a user logs in successfully, and validating the JWT sent in the Authorization header of the requests -</p><pre name="cac0" id="cac0" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.security;<br><br>import io.jsonwebtoken.*;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.beans.factory.annotation.Value;<br>import org.springframework.security.core.Authentication;<br>import org.springframework.stereotype.Component;<br>import java.util.Date;<br><br>@Component<br>public class JwtTokenProvider {<br><br>    private static final Logger logger = LoggerFactory.getLogger(JwtTokenProvider.class);<br><br>    @Value(&quot;${app.jwtSecret}&quot;)<br>    private String jwtSecret;<br><br>    @Value(&quot;${app.jwtExpirationInMs}&quot;)<br>    private int jwtExpirationInMs;<br><br>    public String generateToken(Authentication authentication) {<br><br>        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();<br><br>        Date now = new Date();<br>        Date expiryDate = new Date(now.getTime() + jwtExpirationInMs);<br><br>        return Jwts.builder()<br>                .setSubject(Long.toString(userPrincipal.getId()))<br>                .setIssuedAt(new Date())<br>                .setExpiration(expiryDate)<br>                .signWith(SignatureAlgorithm.HS512, jwtSecret)<br>                .compact();<br>    }<br><br>    public Long getUserIdFromJWT(String token) {<br>        Claims claims = Jwts.parser()<br>                .setSigningKey(jwtSecret)<br>                .parseClaimsJws(token)<br>                .getBody();<br><br>        return Long.parseLong(claims.getSubject());<br>    }<br><br>    public boolean validateToken(String authToken) {<br>        try {<br>            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(authToken);<br>            return true;<br>        } catch (SignatureException ex) {<br>            logger.error(&quot;Invalid JWT signature&quot;);<br>        } catch (MalformedJwtException ex) {<br>            logger.error(&quot;Invalid JWT token&quot;);<br>        } catch (ExpiredJwtException ex) {<br>            logger.error(&quot;Expired JWT token&quot;);<br>        } catch (UnsupportedJwtException ex) {<br>            logger.error(&quot;Unsupported JWT token&quot;);<br>        } catch (IllegalArgumentException ex) {<br>            logger.error(&quot;JWT claims string is empty.&quot;);<br>        }<br>        return false;<br>    }<br>}</code></pre><p name="d289" id="d289" class="graf graf--p graf-after--pre">The utility class reads the JWT secret and expiration time from <code class="markup--code markup--p-code">properties</code>.</p><p name="ccee" id="ccee" class="graf graf--p graf-after--p">Let’s add the <code class="markup--code markup--p-code">jwtSecret</code> and <code class="markup--code markup--p-code">jwtExpirationInMs</code> properties in the <code class="markup--code markup--p-code">application.properties</code> file -</p><p name="a27e" id="a27e" class="graf graf--p graf-after--p">JWT Properties</p><pre name="3b0a" id="3b0a" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">## App Properties<br>app.jwtSecret= JWTSuperSecretKey<br>app.jwtExpirationInMs = 604800000</code></pre><h3 name="2356" id="2356" class="graf graf--h3 graf-after--pre">5. Custom Spring Security AuthenticationFilter</h3><p name="86ca" id="86ca" class="graf graf--p graf-after--h3">Finally, Let’s write the <code class="markup--code markup--p-code">JWTAuthenticationFilter</code> to get the JWT token from the request, validate it, load the user associated with the token, and pass it to Spring Security -</p><pre name="15f4" id="15f4" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.security;</code></pre><pre name="5842" id="5842" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br>import org.springframework.security.core.context.SecurityContextHolder;<br>import org.springframework.security.core.userdetails.UserDetails;<br>import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;<br>import org.springframework.util.StringUtils;<br>import org.springframework.web.filter.OncePerRequestFilter;<br>import javax.servlet.FilterChain;<br>import javax.servlet.ServletException;<br>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;<br>import java.io.IOException;</code></pre><pre name="1453" id="1453" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class JwtAuthenticationFilter extends OncePerRequestFilter {</code></pre><pre name="a53d" id="a53d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    private JwtTokenProvider tokenProvider;</code></pre><pre name="f9b7" id="f9b7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    private CustomUserDetailsService customUserDetailsService;</code></pre><pre name="74bc" id="74bc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private static final Logger logger = LoggerFactory.getLogger(JwtAuthenticationFilter.class);</code></pre><pre name="5a5f" id="5a5f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {<br>        try {<br>            String jwt = getJwtFromRequest(request);</code></pre><pre name="dd92" id="dd92" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">            if (StringUtils.hasText(jwt) &amp;&amp; tokenProvider.validateToken(jwt)) {<br>                Long userId = tokenProvider.getUserIdFromJWT(jwt);</code></pre><pre name="6e9f" id="6e9f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">                UserDetails userDetails = customUserDetailsService.loadUserById(userId);<br>                UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());<br>                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</code></pre><pre name="21b9" id="21b9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">                SecurityContextHolder.getContext().setAuthentication(authentication);<br>            }<br>        } catch (Exception ex) {<br>            logger.error(&quot;Could not set user authentication in security context&quot;, ex);<br>        }</code></pre><pre name="7e3c" id="7e3c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        filterChain.doFilter(request, response);<br>    }</code></pre><pre name="2157" id="2157" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private String getJwtFromRequest(HttpServletRequest request) {<br>        String bearerToken = request.getHeader(&quot;Authorization&quot;);<br>        if (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {<br>            return bearerToken.substring(7, bearerToken.length());<br>        }<br>        return null;<br>    }<br>}</code></pre><p name="7728" id="7728" class="graf graf--p graf-after--pre">In the above <code class="markup--code markup--p-code">filter</code>, We’re first parsing the JWT retrieved from the <code class="markup--code markup--p-code">Authorization</code> header of the request and obtaining the user’s Id. After that, We’re loading the user’s details from the database and setting the authentication inside spring security’s context.</p><p name="8963" id="8963" class="graf graf--p graf-after--p">Note that, the database hit in the above <code class="markup--code markup--p-code">filter</code> is optional. You could also encode the user’s username and roles inside JWT claims and create the <code class="markup--code markup--p-code">UserDetails</code> object by parsing those claims from the JWT. That would avoid the database hit.</p><p name="2db5" id="2db5" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">However, Loading the current details of the user from the database might still be helpful. For example, you might wanna disallow login with this JWT if the user’s role has changed, or the user has updated his password after the creation of this JWT.</em></p><h3 name="a091" id="a091" class="graf graf--h3 graf-after--p">6. Custom annotation to access currently logged in user</h3><p name="2280" id="2280" class="graf graf--p graf-after--h3">Spring security provides an annotation called <code class="markup--code markup--p-code">@AuthenticationPrincipal</code> to access the currently authenticated user in the controllers.</p><p name="7f19" id="7f19" class="graf graf--p graf-after--p">The following <code class="markup--code markup--p-code">CurrentUser</code> annotation is a wrapper around <code class="markup--code markup--p-code">@AuthenticationPrincipal</code> annotation.</p><pre name="bf5b" id="bf5b" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.security;<br><br>import org.springframework.security.core.annotation.AuthenticationPrincipal;<br>import java.lang.annotation.*;<br><br>@Target({ElementType.PARAMETER, ElementType.TYPE})<br>@Retention(RetentionPolicy.RUNTIME)<br>@Documented<br>@AuthenticationPrincipal<br>public @interface CurrentUser {<br><br>}</code></pre><p name="6180" id="6180" class="graf graf--p graf-after--pre">We’ve created a meta-annotation so that we don’t get too much tied up of with Spring Security related annotations everywhere in our project. This reduces the dependency on Spring Security. So if we decide to remove Spring Security from our project, we can easily do it by simply changing the <code class="markup--code markup--p-code">CurrentUser</code> annotation-</p><h3 name="748a" id="748a" class="graf graf--h3 graf-after--p">Writing the Login and Signup APIs</h3><p name="d7d2" id="d7d2" class="graf graf--p graf-after--h3">All right folks! We’re done with all the security configurations that were required. It’s time to finally write the login and signup APIs.</p><p name="8b74" id="8b74" class="graf graf--p graf-after--p">But, Before defining the APIs, we’ll need to define the request and response payloads that the APIs will use. So let’s define these payloads first.</p><p name="5012" id="5012" class="graf graf--p graf-after--p">All the request and response payloads will go inside a package named <code class="markup--code markup--p-code">com.example.polls.payload</code>.</p><h3 name="b3bb" id="b3bb" class="graf graf--h3 graf-after--p">Request Payloads</h3><h4 name="de05" id="de05" class="graf graf--h4 graf-after--h3">1. LoginRequest</h4><pre name="a034" id="a034" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="f93a" id="f93a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.validation.constraints.NotBlank;</code></pre><pre name="b74f" id="b74f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class LoginRequest {<br>    @NotBlank<br>    private String usernameOrEmail;</code></pre><pre name="b030" id="b030" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotBlank<br>    private String password;</code></pre><pre name="b3d2" id="b3d2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getUsernameOrEmail() {<br>        return usernameOrEmail;<br>    }</code></pre><pre name="39ed" id="39ed" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setUsernameOrEmail(String usernameOrEmail) {<br>        this.usernameOrEmail = usernameOrEmail;<br>    }</code></pre><pre name="cc0a" id="cc0a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getPassword() {<br>        return password;<br>    }</code></pre><pre name="fe9e" id="fe9e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPassword(String password) {<br>        this.password = password;<br>    }<br>}</code></pre><h4 name="bc8f" id="bc8f" class="graf graf--h4 graf-after--pre">2. SignUpRequest</h4><pre name="22e7" id="22e7" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="7333" id="7333" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.validation.constraints.*;</code></pre><pre name="961d" id="961d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class SignUpRequest {<br>    @NotBlank<br>    @Size(min = 4, max = 40)<br>    private String name;</code></pre><pre name="1d28" id="1d28" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotBlank<br>    @Size(min = 3, max = 15)<br>    private String username;</code></pre><pre name="1f2c" id="1f2c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotBlank<br>    @Size(max = 40)<br>    @Email<br>    private String email;</code></pre><pre name="a3f8" id="a3f8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotBlank<br>    @Size(min = 6, max = 20)<br>    private String password;</code></pre><pre name="5515" id="5515" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getName() {<br>        return name;<br>    }</code></pre><pre name="42b4" id="42b4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setName(String name) {<br>        this.name = name;<br>    }</code></pre><pre name="be24" id="be24" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getUsername() {<br>        return username;<br>    }</code></pre><pre name="2555" id="2555" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setUsername(String username) {<br>        this.username = username;<br>    }</code></pre><pre name="d977" id="d977" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getEmail() {<br>        return email;<br>    }</code></pre><pre name="b669" id="b669" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setEmail(String email) {<br>        this.email = email;<br>    }</code></pre><pre name="cf0b" id="cf0b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getPassword() {<br>        return password;<br>    }</code></pre><pre name="cd2b" id="cd2b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPassword(String password) {<br>        this.password = password;<br>    }<br>}</code></pre><h3 name="8a3f" id="8a3f" class="graf graf--h3 graf-after--pre">Response Payloads</h3><h4 name="f4d7" id="f4d7" class="graf graf--h4 graf-after--h3">1. JwtAuthenticationResponse</h4><pre name="6c4f" id="6c4f" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="51ec" id="51ec" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class JwtAuthenticationResponse {<br>    private String accessToken;<br>    private String tokenType = &quot;Bearer&quot;;</code></pre><pre name="cd02" id="cd02" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public JwtAuthenticationResponse(String accessToken) {<br>        this.accessToken = accessToken;<br>    }</code></pre><pre name="3ee4" id="3ee4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getAccessToken() {<br>        return accessToken;<br>    }</code></pre><pre name="6658" id="6658" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setAccessToken(String accessToken) {<br>        this.accessToken = accessToken;<br>    }</code></pre><pre name="bfb6" id="bfb6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getTokenType() {<br>        return tokenType;<br>    }</code></pre><pre name="d227" id="d227" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setTokenType(String tokenType) {<br>        this.tokenType = tokenType;<br>    }<br>}</code></pre><h4 name="0414" id="0414" class="graf graf--h4 graf-after--pre">2. ApiResponse</h4><pre name="a2d0" id="a2d0" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="c9cb" id="c9cb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class ApiResponse {<br>    private Boolean success;<br>    private String message;</code></pre><pre name="e1e8" id="e1e8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public ApiResponse(Boolean success, String message) {<br>        this.success = success;<br>        this.message = message;<br>    }</code></pre><pre name="5b8d" id="5b8d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Boolean getSuccess() {<br>        return success;<br>    }</code></pre><pre name="c3d2" id="c3d2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setSuccess(Boolean success) {<br>        this.success = success;<br>    }</code></pre><pre name="6b51" id="6b51" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getMessage() {<br>        return message;<br>    }</code></pre><pre name="4e4c" id="4e4c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setMessage(String message) {<br>        this.message = message;<br>    }<br>}</code></pre><h3 name="3c50" id="3c50" class="graf graf--h3 graf-after--pre">Custom Business Exceptions</h3><p name="6504" id="6504" class="graf graf--p graf-after--h3">The APIs will throw exceptions if the request is not valid or some unexpected situation occurs.</p><p name="0f37" id="0f37" class="graf graf--p graf-after--p">We would also want to respond with different HTTP status codes for different types of exceptions.</p><p name="3466" id="3466" class="graf graf--p graf-after--p">Let’s define these exceptions along with the corresponding <code class="markup--code markup--p-code">@ResponseStatus</code> (All the exception classes will go inside a package named <code class="markup--code markup--p-code">com.example.polls.exception</code>) -</p><h4 name="f7e2" id="f7e2" class="graf graf--h4 graf-after--p">1. AppException</h4><pre name="2d73" id="2d73" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.exception;</code></pre><pre name="ff19" id="ff19" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import org.springframework.http.HttpStatus;<br>import org.springframework.web.bind.annotation.ResponseStatus;</code></pre><pre name="78f4" id="78f4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)<br>public class AppException extends RuntimeException {<br>    public AppException(String message) {<br>        super(message);<br>    }</code></pre><pre name="c57f" id="c57f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public AppException(String message, Throwable cause) {<br>        super(message, cause);<br>    }<br>}</code></pre><h4 name="ea42" id="ea42" class="graf graf--h4 graf-after--pre">2. BadRequestException</h4><pre name="c752" id="c752" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.exception;</code></pre><pre name="265c" id="265c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import org.springframework.http.HttpStatus;<br>import org.springframework.web.bind.annotation.ResponseStatus;</code></pre><pre name="f903" id="f903" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@ResponseStatus(HttpStatus.BAD_REQUEST)<br>public class BadRequestException extends RuntimeException {</code></pre><pre name="ff1a" id="ff1a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public BadRequestException(String message) {<br>        super(message);<br>    }</code></pre><pre name="c602" id="c602" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public BadRequestException(String message, Throwable cause) {<br>        super(message, cause);<br>    }<br>}</code></pre><h4 name="88a1" id="88a1" class="graf graf--h4 graf-after--pre">3. ResourceNotFoundException</h4><pre name="b747" id="b747" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.exception;</code></pre><pre name="87ec" id="87ec" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import org.springframework.http.HttpStatus;<br>import org.springframework.web.bind.annotation.ResponseStatus;</code></pre><pre name="3e6d" id="3e6d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@ResponseStatus(HttpStatus.NOT_FOUND)<br>public class ResourceNotFoundException extends RuntimeException {<br>    private String resourceName;<br>    private String fieldName;<br>    private Object fieldValue;</code></pre><pre name="92a0" id="92a0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public ResourceNotFoundException( String resourceName, String fieldName, Object fieldValue) {<br>        super(String.format(&quot;%s not found with %s : &#39;%s&#39;&quot;, resourceName, fieldName, fieldValue));<br>        this.resourceName = resourceName;<br>        this.fieldName = fieldName;<br>        this.fieldValue = fieldValue;<br>    }</code></pre><pre name="3e52" id="3e52" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getResourceName() {<br>        return resourceName;<br>    }</code></pre><pre name="074e" id="074e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getFieldName() {<br>        return fieldName;<br>    }</code></pre><pre name="c510" id="c510" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Object getFieldValue() {<br>        return fieldValue;<br>    }<br>}</code></pre><h3 name="0993" id="0993" class="graf graf--h3 graf-after--pre">Authentication Controller</h3><p name="d869" id="d869" class="graf graf--p graf-after--h3">Finally, Here is the complete code for <code class="markup--code markup--p-code">AuthController</code> that contains APIs for login and signup (All the controllers in our project will go inside a package named <code class="markup--code markup--p-code">com.example.polls.controller</code>) -</p><pre name="2767" id="2767" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.controller;</code></pre><pre name="8d4b" id="8d4b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.exception.AppException;<br>import com.example.polls.model.Role;<br>import com.example.polls.model.RoleName;<br>import com.example.polls.model.User;<br>import com.example.polls.payload.ApiResponse;<br>import com.example.polls.payload.JwtAuthenticationResponse;<br>import com.example.polls.payload.LoginRequest;<br>import com.example.polls.payload.SignUpRequest;<br>import com.example.polls.repository.RoleRepository;<br>import com.example.polls.repository.UserRepository;<br>import com.example.polls.security.JwtTokenProvider;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.http.HttpStatus;<br>import org.springframework.http.ResponseEntity;<br>import org.springframework.security.authentication.AuthenticationManager;<br>import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;<br>import org.springframework.security.core.Authentication;<br>import org.springframework.security.core.context.SecurityContextHolder;<br>import org.springframework.security.crypto.password.PasswordEncoder;<br>import org.springframework.web.bind.annotation.PostMapping;<br>import org.springframework.web.bind.annotation.RequestBody;<br>import org.springframework.web.bind.annotation.RequestMapping;<br>import org.springframework.web.bind.annotation.RestController;<br>import org.springframework.web.servlet.support.ServletUriComponentsBuilder;</code></pre><pre name="d3c4" id="d3c4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.validation.Valid;<br>import java.net.URI;<br>import java.util.Collections;</code></pre><pre name="e6fb" id="e6fb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@RestController<br>@RequestMapping(&quot;/api/auth&quot;)<br>public class AuthController {</code></pre><pre name="f74f" id="f74f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    AuthenticationManager authenticationManager;</code></pre><pre name="65b9" id="65b9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    UserRepository userRepository;</code></pre><pre name="5159" id="5159" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    RoleRepository roleRepository;</code></pre><pre name="a9d6" id="a9d6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    PasswordEncoder passwordEncoder;</code></pre><pre name="9576" id="9576" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    JwtTokenProvider tokenProvider;</code></pre><pre name="7c08" id="7c08" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @PostMapping(&quot;/signin&quot;)<br>    public ResponseEntity&lt;?&gt; authenticateUser(@Valid @RequestBody LoginRequest loginRequest) {</code></pre><pre name="58f3" id="58f3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Authentication authentication = authenticationManager.authenticate(<br>                new UsernamePasswordAuthenticationToken(<br>                        loginRequest.getUsernameOrEmail(),<br>                        loginRequest.getPassword()<br>                )<br>        );</code></pre><pre name="f870" id="f870" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        SecurityContextHolder.getContext().setAuthentication(authentication);</code></pre><pre name="42f9" id="42f9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        String jwt = tokenProvider.generateToken(authentication);<br>        return ResponseEntity.ok(new JwtAuthenticationResponse(jwt));<br>    }</code></pre><pre name="6294" id="6294" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @PostMapping(&quot;/signup&quot;)<br>    public ResponseEntity&lt;?&gt; registerUser(@Valid @RequestBody SignUpRequest signUpRequest) {<br>        if(userRepository.existsByUsername(signUpRequest.getUsername())) {<br>            return new ResponseEntity(new ApiResponse(false, &quot;Username is already taken!&quot;),<br>                    HttpStatus.BAD_REQUEST);<br>        }</code></pre><pre name="8667" id="8667" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if(userRepository.existsByEmail(signUpRequest.getEmail())) {<br>            return new ResponseEntity(new ApiResponse(false, &quot;Email Address already in use!&quot;),<br>                    HttpStatus.BAD_REQUEST);<br>        }</code></pre><pre name="91d7" id="91d7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Creating user&#39;s account<br>        User user = new User(signUpRequest.getName(), signUpRequest.getUsername(),<br>                signUpRequest.getEmail(), signUpRequest.getPassword());</code></pre><pre name="cbc6" id="cbc6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        user.setPassword(passwordEncoder.encode(user.getPassword()));</code></pre><pre name="a4f3" id="a4f3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Role userRole = roleRepository.findByName(RoleName.ROLE_USER)<br>                .orElseThrow(() -&gt; new AppException(&quot;User Role not set.&quot;));</code></pre><pre name="b043" id="b043" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        user.setRoles(Collections.singleton(userRole));</code></pre><pre name="adb0" id="adb0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        User result = userRepository.save(user);</code></pre><pre name="dff0" id="dff0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        URI location = ServletUriComponentsBuilder<br>                .fromCurrentContextPath().path(&quot;/api/users/{username}&quot;)<br>                .buildAndExpand(result.getUsername()).toUri();</code></pre><pre name="0c02" id="0c02" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return ResponseEntity.created(location).body(new ApiResponse(true, &quot;User registered successfully&quot;));<br>    }<br>}</code></pre><h3 name="2136" id="2136" class="graf graf--h3 graf-after--pre">Enabling CORS</h3><p name="51d9" id="51d9" class="graf graf--p graf-after--h3">We’ll be accessing the APIs from the react client that will run on its own development server. To allow cross origin requests from the react client, create the following <code class="markup--code markup--p-code">WebMvcConfig</code> class inside <code class="markup--code markup--p-code">com.example.polls.config</code> package -</p><pre name="c66c" id="c66c" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.config;</code></pre><pre name="97d4" id="97d4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import org.springframework.context.annotation.Configuration;<br>import org.springframework.web.servlet.config.annotation.CorsRegistry;<br>import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</code></pre><pre name="b2df" id="b2df" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Configuration<br>public class WebMvcConfig implements WebMvcConfigurer {</code></pre><pre name="43d3" id="43d3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private final long MAX_AGE_SECS = 3600;</code></pre><pre name="be92" id="be92" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public void addCorsMappings(CorsRegistry registry) {<br>        registry.addMapping(&quot;/**&quot;)<br>                .allowedOrigins(&quot;*&quot;)<br>                .allowedMethods(&quot;HEAD&quot;, &quot;OPTIONS&quot;, &quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;PATCH&quot;, &quot;DELETE&quot;)<br>                .maxAge(MAX_AGE_SECS);<br>    }<br>}</code></pre><h3 name="268b" id="268b" class="graf graf--h3 graf-after--pre">Exploring the current project setup &amp; Running the Application</h3><p name="f76a" id="f76a" class="graf graf--p graf-after--h3">If you have followed along and defined all the classes presented in this article, then your project’s directory structure should look like this-</p><figure name="053f" id="053f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 1074px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 153.5%;"></div><img class="graf-image" data-image-id="0*RjS1At1tIrtEP89c.jpg" data-width="916" data-height="1406" src="https://cdn-images-1.medium.com/max/800/0*RjS1At1tIrtEP89c.jpg"></div></figure><p name="4356" id="4356" class="graf graf--p graf-after--figure">You can run the application by typing the following command from the root directory of your project -</p><pre name="ad04" id="ad04" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">mvn spring-boot:run</code></pre><h3 name="8971" id="8971" class="graf graf--h3 graf-after--pre">Testing the Login and Signup APIs</h3><p name="d5b9" id="d5b9" class="graf graf--p graf-after--h3">Let’s now test the login and signup APIs from Postman.</p><h3 name="0b76" id="0b76" class="graf graf--h3 graf-after--p">SignUp</h3><figure name="84d8" id="84d8" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 353px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 50.5%;"></div><img class="graf-image" data-image-id="1*OFy9097C4avcWskpYbqp6w.jpeg" data-width="1515" data-height="765" src="https://cdn-images-1.medium.com/max/800/1*OFy9097C4avcWskpYbqp6w.jpeg"></div></figure><h3 name="ed42" id="ed42" class="graf graf--h3 graf-after--figure">Login</h3><figure name="a4cd" id="a4cd" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 345px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 49.2%;"></div><img class="graf-image" data-image-id="1*Acu6zWLp6t890utagPmNhA.jpeg" data-width="1513" data-height="745" src="https://cdn-images-1.medium.com/max/800/1*Acu6zWLp6t890utagPmNhA.jpeg"></div></figure><h3 name="9f40" id="9f40" class="graf graf--h3 graf-after--figure">Calling Protected APIs</h3><p name="c2d6" id="c2d6" class="graf graf--p graf-after--h3">Once you’ve obtained the access token using the login API, you can call any protected API by passing the accessToken in the <code class="markup--code markup--p-code">Authorization</code> header of the request like so -</p><pre name="cb84" id="cb84" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">Authorization: Bearer &lt;accessToken&gt;</code></pre><p name="bc47" id="bc47" class="graf graf--p graf-after--pre">The <code class="markup--code markup--p-code">JwtAuthenticationFilter</code> will read the accessToken from the header, verify it, and allow/deny access to the API.</p><p name="5452" id="5452" class="graf graf--p graf-after--p">Then, We’ll build Rest APIs to create and retrieve Polls, vote for a choice in a Poll, get a user’s profile and much more.</p><figure name="60be" id="60be" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 398px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.89999999999999%;"></div><img class="graf-image" data-image-id="1*NScOb8V7_UlHXXe4RGgmvA.jpeg" data-width="1160" data-height="660" src="https://cdn-images-1.medium.com/max/800/1*NScOb8V7_UlHXXe4RGgmvA.jpeg"></div></figure><p name="aef0" id="aef0" class="graf graf--p graf-after--figure">Before building the Rest APIs, we’ll need to create the domain models for <code class="markup--code markup--p-code">Poll</code>, <code class="markup--code markup--p-code">Choice</code> and <code class="markup--code markup--p-code">Vote</code>.</p><p name="8b56" id="8b56" class="graf graf--p graf-after--p">We would want to include information about who created or updated a poll in the <code class="markup--code markup--p-code">Poll</code> model, and automatically populate this information based on the currently logged in user.</p><h3 name="5f16" id="5f16" class="graf graf--h3 graf-after--p">Auditing Model and Configurations</h3><p name="227b" id="227b" class="graf graf--p graf-after--h3">To achieve user auditing, let’s define an auditing model called <code class="markup--code markup--p-code">UserDateAudit</code> which extends the <code class="markup--code markup--p-code">DateAudit</code> model that we defined in the first part.</p><p name="1778" id="1778" class="graf graf--p graf-after--p">It includes <code class="markup--code markup--p-code">createdBy</code> and <code class="markup--code markup--p-code">updatedBy</code> fields.</p><h3 name="197c" id="197c" class="graf graf--h3 graf-after--p">UserDateAudit model</h3><p name="a39f" id="a39f" class="graf graf--p graf-after--h3">Create the following <code class="markup--code markup--p-code">UserDateAudit</code> class inside <code class="markup--code markup--p-code">com.example.polls.model.audit</code> package -</p><pre name="755b" id="755b" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.model.audit;<br><br>import com.fasterxml.jackson.annotation.JsonIgnoreProperties;<br>import org.springframework.data.annotation.CreatedBy;<br>import org.springframework.data.annotation.LastModifiedBy;<br><br>import javax.persistence.Column;<br>import javax.persistence.MappedSuperclass;<br><br>@MappedSuperclass<br>@JsonIgnoreProperties(<br>        value = {&quot;createdBy&quot;, &quot;updatedBy&quot;},<br>        allowGetters = true<br>)<br>public abstract class UserDateAudit extends DateAudit {<br>    @CreatedBy<br>    @Column(updatable = false)<br>    private Long createdBy;<br><br>    @LastModifiedBy<br>    private Long updatedBy;<br><br>    public Long getCreatedBy() {<br>        return createdBy;<br>    }<br><br>    public void setCreatedBy(Long createdBy) {<br>        this.createdBy = createdBy;<br>    }<br><br>    public Long getUpdatedBy() {<br>        return updatedBy;<br>    }<br><br>    public void setUpdatedBy(Long updatedBy) {<br>        this.updatedBy = updatedBy;<br>    }<br>}</code></pre><h3 name="15d8" id="15d8" class="graf graf--h3 graf-after--pre">Auditing configuration</h3><p name="574c" id="574c" class="graf graf--p graf-after--h3">Now, to automatically populate the <code class="markup--code markup--p-code">createdBy</code> and <code class="markup--code markup--p-code">updatedBy</code> fields, we need to make the following modifications to the <code class="markup--code markup--p-code">AuditingConfig</code> class -</p><pre name="460e" id="460e" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.config;</code></pre><pre name="b072" id="b072" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.security.UserPrincipal;<br>import org.springframework.context.annotation.Bean;<br>import org.springframework.context.annotation.Configuration;<br>import org.springframework.data.domain.AuditorAware;<br>import org.springframework.data.jpa.repository.config.EnableJpaAuditing;<br>import org.springframework.security.authentication.AnonymousAuthenticationToken;<br>import org.springframework.security.core.Authentication;<br>import org.springframework.security.core.context.SecurityContextHolder;<br>import java.util.Optional;</code></pre><pre name="3946" id="3946" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Configuration<br>@EnableJpaAuditing<br>public class AuditingConfig {</code></pre><pre name="113e" id="113e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Bean<br>    public AuditorAware&lt;Long&gt; auditorProvider() {<br>        return new SpringSecurityAuditAwareImpl();<br>    }<br>}</code></pre><pre name="aed8" id="aed8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">class SpringSecurityAuditAwareImpl implements AuditorAware&lt;Long&gt; {</code></pre><pre name="3862" id="3862" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public Optional&lt;Long&gt; getCurrentAuditor() {<br>        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</code></pre><pre name="2eec" id="2eec" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if (authentication == null ||<br>                !authentication.isAuthenticated() ||<br>                authentication instanceof AnonymousAuthenticationToken) {<br>            return Optional.empty();<br>        }</code></pre><pre name="6d75" id="6d75" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        UserPrincipal userPrincipal = (UserPrincipal) authentication.getPrincipal();<br>        <br>        return Optional.ofNullable(userPrincipal.getId());<br>    }<br>}</code></pre><h3 name="a8f7" id="a8f7" class="graf graf--h3 graf-after--pre">Business models</h3><h3 name="b358" id="b358" class="graf graf--h3 graf-after--h3">1. Poll model</h3><p name="aa58" id="aa58" class="graf graf--p graf-after--h3">A poll has an <code class="markup--code markup--p-code">id</code>, a <code class="markup--code markup--p-code">question</code>, a list of <code class="markup--code markup--p-code">choices</code> and an <code class="markup--code markup--p-code">expirationDateTime</code>. Following is the complete <code class="markup--code markup--p-code">Poll</code> class -</p><pre name="a5bd" id="a5bd" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.model;</code></pre><pre name="2139" id="2139" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.audit.UserDateAudit;<br>import org.hibernate.annotations.BatchSize;<br>import org.hibernate.annotations.Fetch;<br>import org.hibernate.annotations.FetchMode;<br>import javax.persistence.*;<br>import javax.validation.constraints.NotBlank;<br>import javax.validation.constraints.NotNull;<br>import javax.validation.constraints.Size;<br>import java.time.Instant;<br>import java.util.ArrayList;<br>import java.util.List;</code></pre><pre name="fbb1" id="fbb1" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Entity<br>@Table(name = &quot;polls&quot;)<br>public class Poll extends UserDateAudit {<br>    @Id<br>    @GeneratedValue(strategy = GenerationType.IDENTITY)<br>    private Long id;</code></pre><pre name="a6aa" id="a6aa" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotBlank<br>    @Size(max = 140)<br>    private String question;</code></pre><pre name="f3b5" id="f3b5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @OneToMany(<br>            mappedBy = &quot;poll&quot;,<br>            cascade = CascadeType.ALL,<br>            fetch = FetchType.EAGER,<br>            orphanRemoval = true<br>    )<br>    @Size(min = 2, max = 6)<br>    @Fetch(FetchMode.SELECT)<br>    @BatchSize(size = 30)<br>    private List&lt;Choice&gt; choices = new ArrayList&lt;&gt;();</code></pre><pre name="78f2" id="78f2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotNull<br>    private Instant expirationDateTime;</code></pre><pre name="60a2" id="60a2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="0dc0" id="0dc0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(Long id) {<br>        this.id = id;<br>    }</code></pre><pre name="e562" id="e562" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getQuestion() {<br>        return question;<br>    }</code></pre><pre name="9c86" id="9c86" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setQuestion(String question) {<br>        this.question = question;<br>    }</code></pre><pre name="d6a6" id="d6a6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public List&lt;Choice&gt; getChoices() {<br>        return choices;<br>    }</code></pre><pre name="ecdc" id="ecdc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setChoices(List&lt;Choice&gt; choices) {<br>        this.choices = choices;<br>    }</code></pre><pre name="993b" id="993b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Instant getExpirationDateTime() {<br>        return expirationDateTime;<br>    }</code></pre><pre name="486a" id="486a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setExpirationDateTime(Instant expirationDateTime) {<br>        this.expirationDateTime = expirationDateTime;<br>    }</code></pre><pre name="365e" id="365e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void addChoice(Choice choice) {<br>        choices.add(choice);<br>        choice.setPoll(this);<br>    }</code></pre><pre name="80d0" id="80d0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void removeChoice(Choice choice) {<br>        choices.remove(choice);<br>        choice.setPoll(null);<br>    }<br>}</code></pre><h3 name="f8b1" id="f8b1" class="graf graf--h3 graf-after--pre">2. Choice model</h3><p name="b693" id="b693" class="graf graf--p graf-after--h3">Every Poll choice has an <code class="markup--code markup--p-code">id</code>, a <code class="markup--code markup--p-code">text</code> and is related to a <code class="markup--code markup--p-code">Poll</code> via a foreign key relationship. Here is the complete <code class="markup--code markup--p-code">Choice</code> class -</p><pre name="d408" id="d408" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.model;</code></pre><pre name="597c" id="597c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.persistence.*;<br>import javax.validation.constraints.NotBlank;<br>import javax.validation.constraints.Size;<br>import java.util.Objects;</code></pre><pre name="6885" id="6885" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Entity<br>@Table(name = &quot;choices&quot;)<br>public class Choice {<br>    @Id<br>    @GeneratedValue(strategy = GenerationType.IDENTITY)<br>    private Long id;</code></pre><pre name="4c3a" id="4c3a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotBlank<br>    @Size(max = 40)<br>    private String text;</code></pre><pre name="514a" id="514a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @ManyToOne(fetch = FetchType.LAZY, optional = false)<br>    @JoinColumn(name = &quot;poll_id&quot;, nullable = false)<br>    private Poll poll;</code></pre><pre name="3d79" id="3d79" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Choice() {</code></pre><pre name="131e" id="131e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    }</code></pre><pre name="bcec" id="bcec" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Choice(String text) {<br>        this.text = text;<br>    }</code></pre><pre name="fe85" id="fe85" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="c4ab" id="c4ab" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(Long id) {<br>        this.id = id;<br>    }</code></pre><pre name="61f7" id="61f7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getText() {<br>        return text;<br>    }</code></pre><pre name="c277" id="c277" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setText(String text) {<br>        this.text = text;<br>    }</code></pre><pre name="fa88" id="fa88" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Poll getPoll() {<br>        return poll;<br>    }</code></pre><pre name="278c" id="278c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPoll(Poll poll) {<br>        this.poll = poll;<br>    }</code></pre><pre name="bc13" id="bc13" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public boolean equals(Object o) {<br>        if (this == o) return true;<br>        if (o == null || getClass() != o.getClass()) return false;<br>        Choice choice = (Choice) o;<br>        return Objects.equals(id, choice.id);<br>    }</code></pre><pre name="cafc" id="cafc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Override<br>    public int hashCode() {<br>        return Objects.hash(id);<br>    }<br>}</code></pre><h3 name="1e42" id="1e42" class="graf graf--h3 graf-after--pre">3. Vote model</h3><p name="7df3" id="7df3" class="graf graf--p graf-after--h3">The <code class="markup--code markup--p-code">Vote</code> class contains information about which user voted for which choice in a poll. Following is the complete <code class="markup--code markup--p-code">Vote</code> class -</p><pre name="92ba" id="92ba" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.model;</code></pre><pre name="9801" id="9801" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.audit.DateAudit;<br>import javax.persistence.*;</code></pre><pre name="0795" id="0795" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Entity<br>@Table(name = &quot;votes&quot;, uniqueConstraints = {<br>        @UniqueConstraint(columnNames = {<br>                &quot;poll_id&quot;,<br>                &quot;user_id&quot;<br>        })<br>})<br>public class Vote extends DateAudit {<br>    @Id<br>    @GeneratedValue(strategy = GenerationType.IDENTITY)<br>    private Long id;</code></pre><pre name="bbca" id="bbca" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @ManyToOne(fetch = FetchType.LAZY, optional = false)<br>    @JoinColumn(name = &quot;poll_id&quot;, nullable = false)<br>    private Poll poll;</code></pre><pre name="62c2" id="62c2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @ManyToOne(fetch = FetchType.LAZY, optional = false)<br>    @JoinColumn(name = &quot;choice_id&quot;, nullable = false)<br>    private Choice choice;</code></pre><pre name="e85c" id="e85c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @ManyToOne(fetch = FetchType.LAZY, optional = false)<br>    @JoinColumn(name = &quot;user_id&quot;, nullable = false)<br>    private User user;</code></pre><pre name="1ff1" id="1ff1" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="83c7" id="83c7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(Long id) {<br>        this.id = id;<br>    }</code></pre><pre name="0735" id="0735" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Poll getPoll() {<br>        return poll;<br>    }</code></pre><pre name="d805" id="d805" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPoll(Poll poll) {<br>        this.poll = poll;<br>    }</code></pre><pre name="36c5" id="36c5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Choice getChoice() {<br>        return choice;<br>    }</code></pre><pre name="39a3" id="39a3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setChoice(Choice choice) {<br>        this.choice = choice;<br>    }</code></pre><pre name="ab98" id="ab98" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public User getUser() {<br>        return user;<br>    }</code></pre><pre name="23cb" id="23cb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setUser(User user) {<br>        this.user = user;<br>    }<br>}</code></pre><h3 name="6746" id="6746" class="graf graf--h3 graf-after--pre">Repositories</h3><p name="9554" id="9554" class="graf graf--p graf-after--h3">Let’s now define the repositories to access <code class="markup--code markup--p-code">Poll</code>, <code class="markup--code markup--p-code">Choice</code> and <code class="markup--code markup--p-code">Vote</code> data from the database.</p><h3 name="c875" id="c875" class="graf graf--h3 graf-after--p">1. PollRepository</h3><pre name="eb0f" id="eb0f" class="graf graf--pre graf-after--h3"><code class="markup--code markup--pre-code">package com.example.polls.repository;</code></pre><pre name="6182" id="6182" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.Poll;<br>import org.springframework.data.domain.Page;<br>import org.springframework.data.domain.Pageable;<br>import org.springframework.data.domain.Sort;<br>import org.springframework.data.jpa.repository.JpaRepository;<br>import org.springframework.stereotype.Repository;<br>import java.util.List;<br>import java.util.Optional;</code></pre><pre name="055e" id="055e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Repository<br>public interface PollRepository extends JpaRepository&lt;Poll, Long&gt; {<br>    Optional&lt;Poll&gt; findById(Long pollId);</code></pre><pre name="26fa" id="26fa" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    Page&lt;Poll&gt; findByCreatedBy(Long userId, Pageable pageable);</code></pre><pre name="0335" id="0335" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    long countByCreatedBy(Long userId);</code></pre><pre name="bcf6" id="bcf6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    List&lt;Poll&gt; findByIdIn(List&lt;Long&gt; pollIds);</code></pre><pre name="e91c" id="e91c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    List&lt;Poll&gt; findByIdIn(List&lt;Long&gt; pollIds, Sort sort);<br>}</code></pre><h3 name="ea45" id="ea45" class="graf graf--h3 graf-after--pre">2. VoteRepository</h3><pre name="06ab" id="06ab" class="graf graf--pre graf-after--h3"><code class="markup--code markup--pre-code">package com.example.polls.repository;</code></pre><pre name="7c84" id="7c84" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.ChoiceVoteCount;<br>import com.example.polls.model.Vote;<br>import org.springframework.data.domain.Page;<br>import org.springframework.data.domain.Pageable;<br>import org.springframework.data.jpa.repository.JpaRepository;<br>import org.springframework.data.jpa.repository.Query;<br>import org.springframework.data.repository.query.Param;<br>import org.springframework.stereotype.Repository;<br>import java.util.List;</code></pre><pre name="87f9" id="87f9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Repository<br>public interface VoteRepository extends JpaRepository&lt;Vote, Long&gt; {<br>    @Query(&quot;SELECT NEW com.example.polls.model.ChoiceVoteCount(v.choice.id, count(v.id)) FROM Vote v WHERE v.poll.id in :pollIds GROUP BY v.choice.id&quot;)<br>    List&lt;ChoiceVoteCount&gt; countByPollIdInGroupByChoiceId(@Param(&quot;pollIds&quot;) List&lt;Long&gt; pollIds);</code></pre><pre name="9eae" id="9eae" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Query(&quot;SELECT NEW com.example.polls.model.ChoiceVoteCount(v.choice.id, count(v.id)) FROM Vote v WHERE v.poll.id = :pollId GROUP BY v.choice.id&quot;)<br>    List&lt;ChoiceVoteCount&gt; countByPollIdGroupByChoiceId(@Param(&quot;pollId&quot;) Long pollId);</code></pre><pre name="9aa3" id="9aa3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Query(&quot;SELECT v FROM Vote v where v.user.id = :userId and v.poll.id in :pollIds&quot;)<br>    List&lt;Vote&gt; findByUserIdAndPollIdIn(@Param(&quot;userId&quot;) Long userId, @Param(&quot;pollIds&quot;) List&lt;Long&gt; pollIds);</code></pre><pre name="16fc" id="16fc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Query(&quot;SELECT v FROM Vote v where v.user.id = :userId and v.poll.id = :pollId&quot;)<br>    Vote findByUserIdAndPollId(@Param(&quot;userId&quot;) Long userId, @Param(&quot;pollId&quot;) Long pollId);</code></pre><pre name="20cc" id="20cc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Query(&quot;SELECT COUNT(v.id) from Vote v where v.user.id = :userId&quot;)<br>    long countByUserId(@Param(&quot;userId&quot;) Long userId);</code></pre><pre name="1345" id="1345" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Query(&quot;SELECT v.poll.id FROM Vote v WHERE v.user.id = :userId&quot;)<br>    Page&lt;Long&gt; findVotedPollIdsByUserId(@Param(&quot;userId&quot;) Long userId, Pageable pageable);<br>}</code></pre><p name="fc4c" id="fc4c" class="graf graf--p graf-after--pre">All of the methods in <code class="markup--code markup--p-code">VoteRepository</code> have a custom query with <code class="markup--code markup--p-code">@Query</code> annotation. I’ve used custom queries because -</p><ul class="postList"><li name="8aeb" id="8aeb" class="graf graf--li graf-after--p">Many of the queries cannot be constructed by <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.details" data-href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.details" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Spring-Data-Jpa’s dynamic query methods</a>.</li><li name="5856" id="5856" class="graf graf--li graf-after--li">Even if they can be constructed, they don’t generate an optimized query.</li></ul><p name="5942" id="5942" class="graf graf--p graf-after--li">Note that, we’re using <a href="https://docs.oracle.com/cd/E12839_01/apirefs.1111/e13946/ejb3_langref.html#ejb3_langref_constructor" data-href="https://docs.oracle.com/cd/E12839_01/apirefs.1111/e13946/ejb3_langref.html#ejb3_langref_constructor" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">JPQL constructor expression</a> in some of the queries to return the query result in the form of a custom class called <code class="markup--code markup--p-code">ChoiceVoteCount</code>.</p><h4 name="150c" id="150c" class="graf graf--h4 graf-after--p">ChoiceVoteCount domain class</h4><p name="56a4" id="56a4" class="graf graf--p graf-after--h4">The <code class="markup--code markup--p-code">ChoiceVoteCount</code> class is used in <code class="markup--code markup--p-code">VoteRepository</code> to return custom results from the query. Here is the complete <code class="markup--code markup--p-code">ChoiceVoteCount</code> class -</p><pre name="a233" id="a233" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.model;</code></pre><pre name="9f1c" id="9f1c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class ChoiceVoteCount {<br>    private Long choiceId;<br>    private Long voteCount;</code></pre><pre name="9082" id="9082" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public ChoiceVoteCount(Long choiceId, Long voteCount) {<br>        this.choiceId = choiceId;<br>        this.voteCount = voteCount;<br>    }</code></pre><pre name="5534" id="5534" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getChoiceId() {<br>        return choiceId;<br>    }</code></pre><pre name="6ce8" id="6ce8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setChoiceId(Long choiceId) {<br>        this.choiceId = choiceId;<br>    }</code></pre><pre name="75ac" id="75ac" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getVoteCount() {<br>        return voteCount;<br>    }</code></pre><pre name="2e20" id="2e20" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setVoteCount(Long voteCount) {<br>        this.voteCount = voteCount;<br>    }<br>}</code></pre><h3 name="c698" id="c698" class="graf graf--h3 graf-after--pre">Defining the Rest APIs</h3><p name="eef1" id="eef1" class="graf graf--p graf-after--h3">Finally, Let’s write the APIs to create a poll, get all polls, vote for a choice in a poll, get a user’s profile, get polls created by a user etc.</p><p name="3d73" id="3d73" class="graf graf--p graf-after--p">Note that, the rest APIs will accept custom payloads in the request, and they will also return custom responses to the clients that include either selected information or additional information.</p><p name="d154" id="d154" class="graf graf--p graf-after--p">Following are the request and response payloads that will be used in the rest APIs (All the payloads go inside a package named <code class="markup--code markup--p-code">com.example.polls.payload</code>)-</p><h3 name="6570" id="6570" class="graf graf--h3 graf-after--p">Request Payloads</h3><h4 name="ddcf" id="ddcf" class="graf graf--h4 graf-after--h3">1. PollRequest</h4><pre name="e46e" id="e46e" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="7283" id="7283" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.validation.Valid;<br>import javax.validation.constraints.NotBlank;<br>import javax.validation.constraints.NotNull;<br>import javax.validation.constraints.Size;<br>import java.util.List;</code></pre><pre name="a383" id="a383" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class PollRequest {<br>    @NotBlank<br>    @Size(max = 140)<br>    private String question;</code></pre><pre name="fb22" id="fb22" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotNull<br>    @Size(min = 2, max = 6)<br>    @Valid<br>    private List&lt;ChoiceRequest&gt; choices;</code></pre><pre name="78ae" id="78ae" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotNull<br>    @Valid<br>    private PollLength pollLength;</code></pre><pre name="dfb7" id="dfb7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getQuestion() {<br>        return question;<br>    }</code></pre><pre name="a482" id="a482" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setQuestion(String question) {<br>        this.question = question;<br>    }</code></pre><pre name="3cb0" id="3cb0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public List&lt;ChoiceRequest&gt; getChoices() {<br>        return choices;<br>    }</code></pre><pre name="d35b" id="d35b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setChoices(List&lt;ChoiceRequest&gt; choices) {<br>        this.choices = choices;<br>    }</code></pre><pre name="29c4" id="29c4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PollLength getPollLength() {<br>        return pollLength;<br>    }</code></pre><pre name="5623" id="5623" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPollLength(PollLength pollLength) {<br>        this.pollLength = pollLength;<br>    }<br>}</code></pre><h4 name="9cc3" id="9cc3" class="graf graf--h4 graf-after--pre">2. ChoiceRequest</h4><pre name="d695" id="d695" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="a735" id="a735" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.validation.constraints.NotBlank;<br>import javax.validation.constraints.Size;</code></pre><pre name="8f87" id="8f87" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class ChoiceRequest {<br>    @NotBlank<br>    @Size(max = 40)<br>    private String text;</code></pre><pre name="37b4" id="37b4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getText() {<br>        return text;<br>    }</code></pre><pre name="3562" id="3562" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setText(String text) {<br>        this.text = text;<br>    }<br>}</code></pre><h4 name="86ee" id="86ee" class="graf graf--h4 graf-after--pre">3. PollLength</h4><pre name="ef37" id="ef37" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="3193" id="3193" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import javax.validation.constraints.Max;<br>import javax.validation.constraints.NotNull;</code></pre><pre name="dc31" id="dc31" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class PollLength {<br>    @NotNull<br>    @Max(7)<br>    private Integer days;</code></pre><pre name="afc7" id="afc7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @NotNull<br>    @Max(23)<br>    private Integer hours;</code></pre><pre name="2db7" id="2db7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public int getDays() {<br>        return days;<br>    }</code></pre><pre name="de74" id="de74" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setDays(int days) {<br>        this.days = days;<br>    }</code></pre><pre name="791a" id="791a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public int getHours() {<br>        return hours;<br>    }</code></pre><pre name="3852" id="3852" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setHours(int hours) {<br>        this.hours = hours;<br>    }<br>}</code></pre><h4 name="9fe0" id="9fe0" class="graf graf--h4 graf-after--pre">4. VoteRequest</h4><pre name="341f" id="341f" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;<br>import javax.validation.constraints.NotNull;</code></pre><pre name="72e0" id="72e0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class VoteRequest {<br>    @NotNull<br>    private Long choiceId;</code></pre><pre name="5f13" id="5f13" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getChoiceId() {<br>        return choiceId;<br>    }</code></pre><pre name="7c31" id="7c31" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setChoiceId(Long choiceId) {<br>        this.choiceId = choiceId;<br>    }<br>}</code></pre><h3 name="4eb7" id="4eb7" class="graf graf--h3 graf-after--pre">Response Payloads</h3><h4 name="2d6e" id="2d6e" class="graf graf--h4 graf-after--h3">1. UserSummary</h4><pre name="4be1" id="4be1" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="660f" id="660f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class UserSummary {<br>    private Long id;<br>    private String username;<br>    private String name;</code></pre><pre name="3bab" id="3bab" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public UserSummary(Long id, String username, String name) {<br>        this.id = id;<br>        this.username = username;<br>        this.name = name;<br>    }</code></pre><pre name="863a" id="863a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="fb2c" id="fb2c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(Long id) {<br>        this.id = id;<br>    }</code></pre><pre name="d7b5" id="d7b5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getUsername() {<br>        return username;<br>    }</code></pre><pre name="f714" id="f714" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setUsername(String username) {<br>        this.username = username;<br>    }</code></pre><pre name="e80c" id="e80c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getName() {<br>        return name;<br>    }</code></pre><pre name="8db5" id="8db5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setName(String name) {<br>        this.name = name;<br>    }<br>}</code></pre><h4 name="df7b" id="df7b" class="graf graf--h4 graf-after--pre">2. UserIdentityAvailability</h4><pre name="777f" id="777f" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="ca45" id="ca45" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class UserIdentityAvailability {<br>    private Boolean available;</code></pre><pre name="3c22" id="3c22" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public UserIdentityAvailability(Boolean available) {<br>        this.available = available;<br>    }</code></pre><pre name="9729" id="9729" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Boolean getAvailable() {<br>        return available;<br>    }</code></pre><pre name="04de" id="04de" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setAvailable(Boolean available) {<br>        this.available = available;<br>    }<br>}</code></pre><h4 name="8d69" id="8d69" class="graf graf--h4 graf-after--pre">3. UserProfile</h4><pre name="ef3d" id="ef3d" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="5fbd" id="5fbd" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import java.time.Instant;</code></pre><pre name="2500" id="2500" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class UserProfile {<br>    private Long id;<br>    private String username;<br>    private String name;<br>    private Instant joinedAt;<br>    private Long pollCount;<br>    private Long voteCount;</code></pre><pre name="d6a7" id="d6a7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public UserProfile(Long id, String username, String name, Instant joinedAt, Long pollCount, Long voteCount) {<br>        this.id = id;<br>        this.username = username;<br>        this.name = name;<br>        this.joinedAt = joinedAt;<br>        this.pollCount = pollCount;<br>        this.voteCount = voteCount;<br>    }</code></pre><pre name="7cf4" id="7cf4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="99dc" id="99dc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(Long id) {<br>        this.id = id;<br>    }</code></pre><pre name="ef1d" id="ef1d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getUsername() {<br>        return username;<br>    }</code></pre><pre name="d843" id="d843" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setUsername(String username) {<br>        this.username = username;<br>    }</code></pre><pre name="d986" id="d986" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getName() {<br>        return name;<br>    }</code></pre><pre name="d828" id="d828" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setName(String name) {<br>        this.name = name;<br>    }</code></pre><pre name="7453" id="7453" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Instant getJoinedAt() {<br>        return joinedAt;<br>    }</code></pre><pre name="4180" id="4180" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setJoinedAt(Instant joinedAt) {<br>        this.joinedAt = joinedAt;<br>    }</code></pre><pre name="e4d2" id="e4d2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getPollCount() {<br>        return pollCount;<br>    }</code></pre><pre name="e71a" id="e71a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPollCount(Long pollCount) {<br>        this.pollCount = pollCount;<br>    }</code></pre><pre name="a5eb" id="a5eb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getVoteCount() {<br>        return voteCount;<br>    }</code></pre><pre name="1670" id="1670" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setVoteCount(Long voteCount) {<br>        this.voteCount = voteCount;<br>    }<br>}</code></pre><h4 name="3e85" id="3e85" class="graf graf--h4 graf-after--pre">4. PollResponse</h4><pre name="adc3" id="adc3" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="b8d9" id="b8d9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.fasterxml.jackson.annotation.JsonInclude;</code></pre><pre name="da31" id="da31" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import java.time.Instant;<br>import java.util.List;</code></pre><pre name="3bc3" id="3bc3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class PollResponse {<br>    private Long id;<br>    private String question;<br>    private List&lt;ChoiceResponse&gt; choices;<br>    private UserSummary createdBy;<br>    private Instant creationDateTime;<br>    private Instant expirationDateTime;<br>    private Boolean isExpired;</code></pre><pre name="0642" id="0642" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @JsonInclude(JsonInclude.Include.NON_NULL)<br>    private Long selectedChoice;<br>    private Long totalVotes;</code></pre><pre name="3d89" id="3d89" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getId() {<br>        return id;<br>    }</code></pre><pre name="100b" id="100b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(Long id) {<br>        this.id = id;<br>    }</code></pre><pre name="4b21" id="4b21" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getQuestion() {<br>        return question;<br>    }</code></pre><pre name="9c2f" id="9c2f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setQuestion(String question) {<br>        this.question = question;<br>    }</code></pre><pre name="75a4" id="75a4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public List&lt;ChoiceResponse&gt; getChoices() {<br>        return choices;<br>    }</code></pre><pre name="4d9a" id="4d9a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setChoices(List&lt;ChoiceResponse&gt; choices) {<br>        this.choices = choices;<br>    }</code></pre><pre name="ba52" id="ba52" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public UserSummary getCreatedBy() {<br>        return createdBy;<br>    }</code></pre><pre name="a455" id="a455" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setCreatedBy(UserSummary createdBy) {<br>        this.createdBy = createdBy;<br>    }<br><br></code></pre><pre name="c208" id="c208" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Instant getCreationDateTime() {<br>        return creationDateTime;<br>    }</code></pre><pre name="a36c" id="a36c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setCreationDateTime(Instant creationDateTime) {<br>        this.creationDateTime = creationDateTime;<br>    }</code></pre><pre name="e65b" id="e65b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Instant getExpirationDateTime() {<br>        return expirationDateTime;<br>    }</code></pre><pre name="505c" id="505c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setExpirationDateTime(Instant expirationDateTime) {<br>        this.expirationDateTime = expirationDateTime;<br>    }</code></pre><pre name="9c6d" id="9c6d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Boolean getExpired() {<br>        return isExpired;<br>    }</code></pre><pre name="01fc" id="01fc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setExpired(Boolean expired) {<br>        isExpired = expired;<br>    }</code></pre><pre name="d1e6" id="d1e6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getSelectedChoice() {<br>        return selectedChoice;<br>    }</code></pre><pre name="f4e8" id="f4e8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setSelectedChoice(Long selectedChoice) {<br>        this.selectedChoice = selectedChoice;<br>    }</code></pre><pre name="f59b" id="f59b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Long getTotalVotes() {<br>        return totalVotes;<br>    }</code></pre><pre name="fea7" id="fea7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setTotalVotes(Long totalVotes) {<br>        this.totalVotes = totalVotes;<br>    }<br>}</code></pre><h4 name="b55e" id="b55e" class="graf graf--h4 graf-after--pre">5. ChoiceResponse</h4><pre name="443c" id="443c" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="52d5" id="52d5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class ChoiceResponse {<br>    private long id;<br>    private String text;<br>    private long voteCount;</code></pre><pre name="a315" id="a315" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public long getId() {<br>        return id;<br>    }</code></pre><pre name="5be6" id="5be6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setId(long id) {<br>        this.id = id;<br>    }</code></pre><pre name="6b1d" id="6b1d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public String getText() {<br>        return text;<br>    }</code></pre><pre name="9ec0" id="9ec0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setText(String text) {<br>        this.text = text;<br>    }</code></pre><pre name="efa0" id="efa0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public long getVoteCount() {<br>        return voteCount;<br>    }</code></pre><pre name="1fc8" id="1fc8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setVoteCount(long voteCount) {<br>        this.voteCount = voteCount;<br>    }<br>}</code></pre><h4 name="41ca" id="41ca" class="graf graf--h4 graf-after--pre">6. PagedResponse</h4><pre name="3821" id="3821" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.payload;</code></pre><pre name="ab4d" id="ab4d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import java.util.List;</code></pre><pre name="a843" id="a843" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class PagedResponse&lt;T&gt; {</code></pre><pre name="9626" id="9626" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private List&lt;T&gt; content;<br>    private int page;<br>    private int size;<br>    private long totalElements;<br>    private int totalPages;<br>    private boolean last;</code></pre><pre name="d92e" id="d92e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PagedResponse() {</code></pre><pre name="c57d" id="c57d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    }</code></pre><pre name="56ab" id="56ab" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PagedResponse(List&lt;T&gt; content, int page, int size, long totalElements, int totalPages, boolean last) {<br>        this.content = content;<br>        this.page = page;<br>        this.size = size;<br>        this.totalElements = totalElements;<br>        this.totalPages = totalPages;<br>        this.last = last;<br>    }</code></pre><pre name="76eb" id="76eb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public List&lt;T&gt; getContent() {<br>        return content;<br>    }</code></pre><pre name="d60e" id="d60e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setContent(List&lt;T&gt; content) {<br>        this.content = content;<br>    }</code></pre><pre name="f8c9" id="f8c9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public int getPage() {<br>        return page;<br>    }</code></pre><pre name="e831" id="e831" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setPage(int page) {<br>        this.page = page;<br>    }</code></pre><pre name="0d2e" id="0d2e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public int getSize() {<br>        return size;<br>    }</code></pre><pre name="b2b8" id="b2b8" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setSize(int size) {<br>        this.size = size;<br>    }</code></pre><pre name="f811" id="f811" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public long getTotalElements() {<br>        return totalElements;<br>    }</code></pre><pre name="3aba" id="3aba" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setTotalElements(long totalElements) {<br>        this.totalElements = totalElements;<br>    }</code></pre><pre name="3be3" id="3be3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public int getTotalPages() {<br>        return totalPages;<br>    }</code></pre><pre name="868c" id="868c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setTotalPages(int totalPages) {<br>        this.totalPages = totalPages;<br>    }</code></pre><pre name="7dc4" id="7dc4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public boolean isLast() {<br>        return last;<br>    }</code></pre><pre name="f422" id="f422" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public void setLast(boolean last) {<br>        this.last = last;<br>    }<br>}</code></pre><h3 name="90be" id="90be" class="graf graf--h3 graf-after--pre">Util classes used by controllers and services</h3><p name="c3c2" id="c3c2" class="graf graf--p graf-after--h3">Apart from the Request and Response payloads, all the rest controllers and services will also be using some utility classes.</p><p name="42b1" id="42b1" class="graf graf--p graf-after--p">Following are few utility classes that are used by our controllers and services -</p><h4 name="5c7c" id="5c7c" class="graf graf--h4 graf-after--p">1. AppConstants</h4><pre name="3808" id="3808" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.util;</code></pre><pre name="2c9f" id="2c9f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public interface AppConstants {<br>    String DEFAULT_PAGE_NUMBER = &quot;0&quot;;<br>    String DEFAULT_PAGE_SIZE = &quot;30&quot;;</code></pre><pre name="e53c" id="e53c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    int MAX_PAGE_SIZE = 50;<br>}</code></pre><h4 name="0c05" id="0c05" class="graf graf--h4 graf-after--pre">2. ModelMapper</h4><pre name="8746" id="8746" class="graf graf--pre graf-after--h4"><code class="markup--code markup--pre-code">package com.example.polls.util;</code></pre><pre name="9075" id="9075" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.model.Poll;<br>import com.example.polls.model.User;<br>import com.example.polls.payload.ChoiceResponse;<br>import com.example.polls.payload.PollResponse;<br>import com.example.polls.payload.UserSummary;</code></pre><pre name="d531" id="d531" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import java.time.Instant;<br>import java.util.List;<br>import java.util.Map;<br>import java.util.stream.Collectors;</code></pre><pre name="6b5d" id="6b5d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">public class ModelMapper {</code></pre><pre name="144a" id="144a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public static PollResponse mapPollToPollResponse(Poll poll, Map&lt;Long, Long&gt; choiceVotesMap, User creator, Long userVote) {<br>        PollResponse pollResponse = new PollResponse();<br>        pollResponse.setId(poll.getId());<br>        pollResponse.setQuestion(poll.getQuestion());<br>        pollResponse.setCreationDateTime(poll.getCreatedAt());<br>        pollResponse.setExpirationDateTime(poll.getExpirationDateTime());<br>        Instant now = Instant.now();<br>        pollResponse.setExpired(poll.getExpirationDateTime().isBefore(now));</code></pre><pre name="2839" id="2839" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        List&lt;ChoiceResponse&gt; choiceResponses = poll.getChoices().stream().map(choice -&gt; {<br>            ChoiceResponse choiceResponse = new ChoiceResponse();<br>            choiceResponse.setId(choice.getId());<br>            choiceResponse.setText(choice.getText());</code></pre><pre name="b448" id="b448" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">            if(choiceVotesMap.containsKey(choice.getId())) {<br>                choiceResponse.setVoteCount(choiceVotesMap.get(choice.getId()));<br>            } else {<br>                choiceResponse.setVoteCount(0);<br>            }<br>            return choiceResponse;<br>        }).collect(Collectors.toList());</code></pre><pre name="a1f3" id="a1f3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        pollResponse.setChoices(choiceResponses);<br>        UserSummary creatorSummary = new UserSummary(creator.getId(), creator.getUsername(), creator.getName());<br>        pollResponse.setCreatedBy(creatorSummary);</code></pre><pre name="c420" id="c420" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if(userVote != null) {<br>            pollResponse.setSelectedChoice(userVote);<br>        }</code></pre><pre name="c621" id="c621" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        long totalVotes = pollResponse.getChoices().stream().mapToLong(ChoiceResponse::getVoteCount).sum();<br>        pollResponse.setTotalVotes(totalVotes);</code></pre><pre name="9be4" id="9be4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return pollResponse;<br>    }<br>}</code></pre><p name="e576" id="e576" class="graf graf--p graf-after--pre">We’ll be mapping the <code class="markup--code markup--p-code">Poll</code> entity to a <code class="markup--code markup--p-code">PollResponse</code> payload which contains a bunch of information like Poll’s creator name, Vote counts of each choice in the Poll, the choice that the currently logged in user has voted for, is the Poll expired etc. All these information will be used in front-end client for presentation.</p><h3 name="4f81" id="4f81" class="graf graf--h3 graf-after--p">Writing the Rest Controllers</h3><p name="3fe5" id="3fe5" class="graf graf--p graf-after--h3">We’re all setup for writing the Rest APIs in the controllers. All the controllers will go inside a package named <code class="markup--code markup--p-code">com.example.polls.controller</code>.</p><h4 name="7cb8" id="7cb8" class="graf graf--h4 graf-after--p">1. PollController</h4><p name="1e4f" id="1e4f" class="graf graf--p graf-after--h4">In <code class="markup--code markup--p-code">PollController</code>, we’ll write the Rest APIs to -</p><ul class="postList"><li name="c4b9" id="c4b9" class="graf graf--li graf-after--p">Create a Poll.</li><li name="f00a" id="f00a" class="graf graf--li graf-after--li">Get a paginated list of polls sorted by their creation time.</li><li name="6a41" id="6a41" class="graf graf--li graf-after--li">Get a Poll by pollId.</li><li name="4043" id="4043" class="graf graf--li graf-after--li">Vote for a choice in a poll.</li></ul><p name="7121" id="7121" class="graf graf--p graf-after--li">The <code class="markup--code markup--p-code">PollController</code> also uses a service called <code class="markup--code markup--p-code">PollService</code> for validating and processing some of the requests. We’ll define <code class="markup--code markup--p-code">PollService</code> in the next section.</p><pre name="e554" id="e554" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.controller;<br><br>import com.example.polls.model.*;<br>import com.example.polls.payload.*;<br>import com.example.polls.repository.PollRepository;<br>import com.example.polls.repository.UserRepository;<br>import com.example.polls.repository.VoteRepository;<br>import com.example.polls.security.CurrentUser;<br>import com.example.polls.security.UserPrincipal;<br>import com.example.polls.service.PollService;<br>import com.example.polls.util.AppConstants;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.http.ResponseEntity;<br>import org.springframework.security.access.prepost.PreAuthorize;<br>import org.springframework.web.bind.annotation.*;<br>import org.springframework.web.servlet.support.ServletUriComponentsBuilder;<br>import javax.validation.Valid;<br>import java.net.URI;<br><br>@RestController<br>@RequestMapping(&quot;/api/polls&quot;)<br>public class PollController {<br><br>    @Autowired<br>    private PollRepository pollRepository;<br><br>    @Autowired<br>    private VoteRepository voteRepository;<br><br>    @Autowired<br>    private UserRepository userRepository;<br><br>    @Autowired<br>    private PollService pollService;<br><br>    private static final Logger logger = LoggerFactory.getLogger(PollController.class);<br><br>    @GetMapping<br>    public PagedResponse&lt;PollResponse&gt; getPolls(@CurrentUser UserPrincipal currentUser,<br>                                                @RequestParam(value = &quot;page&quot;, defaultValue = AppConstants.DEFAULT_PAGE_NUMBER) int page,<br>                                                @RequestParam(value = &quot;size&quot;, defaultValue = AppConstants.DEFAULT_PAGE_SIZE) int size) {<br>        return pollService.getAllPolls(currentUser, page, size);<br>    }<br><br>    @PostMapping<br>    @PreAuthorize(&quot;hasRole(&#39;USER&#39;)&quot;)<br>    public ResponseEntity&lt;?&gt; createPoll(@Valid @RequestBody PollRequest pollRequest) {<br>        Poll poll = pollService.createPoll(pollRequest);<br><br>        URI location = ServletUriComponentsBuilder<br>                .fromCurrentRequest().path(&quot;/{pollId}&quot;)<br>                .buildAndExpand(poll.getId()).toUri();<br><br>        return ResponseEntity.created(location)<br>                .body(new ApiResponse(true, &quot;Poll Created Successfully&quot;));<br>    }<br><br>    @GetMapping(&quot;/{pollId}&quot;)<br>    public PollResponse getPollById(@CurrentUser UserPrincipal currentUser,<br>                                    @PathVariable Long pollId) {<br>        return pollService.getPollById(pollId, currentUser);<br>    }<br><br>    @PostMapping(&quot;/{pollId}/votes&quot;)<br>    @PreAuthorize(&quot;hasRole(&#39;USER&#39;)&quot;)<br>    public PollResponse castVote(@CurrentUser UserPrincipal currentUser,<br>                         @PathVariable Long pollId,<br>                         @Valid @RequestBody VoteRequest voteRequest) {<br>        return pollService.castVoteAndGetUpdatedPoll(pollId, voteRequest, currentUser);<br>    }<br>}</code></pre><h4 name="56c5" id="56c5" class="graf graf--h4 graf-after--pre">2. UserController</h4><p name="b73b" id="b73b" class="graf graf--p graf-after--h4">In <code class="markup--code markup--p-code">UserController</code>, We’ll be writing APIs to -</p><ul class="postList"><li name="a386" id="a386" class="graf graf--li graf-after--p">Get the currently logged in user.</li><li name="4583" id="4583" class="graf graf--li graf-after--li">Check if a username is available for registration.</li><li name="beea" id="beea" class="graf graf--li graf-after--li">Check if an email is available for registration.</li><li name="c82e" id="c82e" class="graf graf--li graf-after--li">Get the public profile of a user.</li><li name="a017" id="a017" class="graf graf--li graf-after--li">Get a paginated list of polls created by a given user.</li><li name="30cd" id="30cd" class="graf graf--li graf-after--li">Get a paginated list of polls in which a given user has voted.</li></ul><pre name="128a" id="128a" class="graf graf--pre graf-after--li"><code class="markup--code markup--pre-code">package com.example.polls.controller;<br><br>import com.example.polls.exception.ResourceNotFoundException;<br>import com.example.polls.model.User;<br>import com.example.polls.payload.*;<br>import com.example.polls.repository.PollRepository;<br>import com.example.polls.repository.UserRepository;<br>import com.example.polls.repository.VoteRepository;<br>import com.example.polls.security.UserPrincipal;<br>import com.example.polls.service.PollService;<br>import com.example.polls.security.CurrentUser;<br>import com.example.polls.util.AppConstants;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.security.access.prepost.PreAuthorize;<br>import org.springframework.web.bind.annotation.*;<br><br>@RestController<br>@RequestMapping(&quot;/api&quot;)<br>public class UserController {<br><br>    @Autowired<br>    private UserRepository userRepository;<br><br>    @Autowired<br>    private PollRepository pollRepository;<br><br>    @Autowired<br>    private VoteRepository voteRepository;<br><br>    @Autowired<br>    private PollService pollService;<br><br>    private static final Logger logger = LoggerFactory.getLogger(UserController.class);<br><br>    @GetMapping(&quot;/user/me&quot;)<br>    @PreAuthorize(&quot;hasRole(&#39;USER&#39;)&quot;)<br>    public UserSummary getCurrentUser(@CurrentUser UserPrincipal currentUser) {<br>        UserSummary userSummary = new UserSummary(currentUser.getId(), currentUser.getUsername(), currentUser.getName());<br>        return userSummary;<br>    }<br><br>    @GetMapping(&quot;/user/checkUsernameAvailability&quot;)<br>    public UserIdentityAvailability checkUsernameAvailability(@RequestParam(value = &quot;username&quot;) String username) {<br>        Boolean isAvailable = !userRepository.existsByUsername(username);<br>        return new UserIdentityAvailability(isAvailable);<br>    }<br><br>    @GetMapping(&quot;/user/checkEmailAvailability&quot;)<br>    public UserIdentityAvailability checkEmailAvailability(@RequestParam(value = &quot;email&quot;) String email) {<br>        Boolean isAvailable = !userRepository.existsByEmail(email);<br>        return new UserIdentityAvailability(isAvailable);<br>    }<br><br>    @GetMapping(&quot;/users/{username}&quot;)<br>    public UserProfile getUserProfile(@PathVariable(value = &quot;username&quot;) String username) {<br>        User user = userRepository.findByUsername(username)<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;User&quot;, &quot;username&quot;, username));<br><br>        long pollCount = pollRepository.countByCreatedBy(user.getId());<br>        long voteCount = voteRepository.countByUserId(user.getId());<br><br>        UserProfile userProfile = new UserProfile(user.getId(), user.getUsername(), user.getName(), user.getCreatedAt(), pollCount, voteCount);<br><br>        return userProfile;<br>    }<br><br>    @GetMapping(&quot;/users/{username}/polls&quot;)<br>    public PagedResponse&lt;PollResponse&gt; getPollsCreatedBy(@PathVariable(value = &quot;username&quot;) String username,<br>                                                         @CurrentUser UserPrincipal currentUser,<br>                                                         @RequestParam(value = &quot;page&quot;, defaultValue = AppConstants.DEFAULT_PAGE_NUMBER) int page,<br>                                                         @RequestParam(value = &quot;size&quot;, defaultValue = AppConstants.DEFAULT_PAGE_SIZE) int size) {<br>        return pollService.getPollsCreatedBy(username, currentUser, page, size);<br>    }<br><br><br>    @GetMapping(&quot;/users/{username}/votes&quot;)<br>    public PagedResponse&lt;PollResponse&gt; getPollsVotedBy(@PathVariable(value = &quot;username&quot;) String username,<br>                                                       @CurrentUser UserPrincipal currentUser,<br>                                                       @RequestParam(value = &quot;page&quot;, defaultValue = AppConstants.DEFAULT_PAGE_NUMBER) int page,<br>                                                       @RequestParam(value = &quot;size&quot;, defaultValue = AppConstants.DEFAULT_PAGE_SIZE) int size) {<br>        return pollService.getPollsVotedBy(username, currentUser, page, size);<br>    }<br><br>}</code></pre><h3 name="0dfb" id="0dfb" class="graf graf--h3 graf-after--pre">The Service layer — PollService</h3><p name="e703" id="e703" class="graf graf--p graf-after--h3">Both the controllers <code class="markup--code markup--p-code">PollController</code> and <code class="markup--code markup--p-code">UserController</code> use the <code class="markup--code markup--p-code">PollService</code> class to get the list of polls formatted in the form of <code class="markup--code markup--p-code">PollResponse</code> payloads that is returned to the clients.</p><p name="7e8d" id="7e8d" class="graf graf--p graf-after--p">Here is the complete code for <code class="markup--code markup--p-code">PollService</code> (All the services go inside a package named <code class="markup--code markup--p-code">com.example.polls.service</code>) -</p><pre name="b4ce" id="b4ce" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">package com.example.polls.service;</code></pre><pre name="e15d" id="e15d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">import com.example.polls.exception.BadRequestException;<br>import com.example.polls.exception.ResourceNotFoundException;<br>import com.example.polls.model.*;<br>import com.example.polls.payload.PagedResponse;<br>import com.example.polls.payload.PollRequest;<br>import com.example.polls.payload.PollResponse;<br>import com.example.polls.payload.VoteRequest;<br>import com.example.polls.repository.PollRepository;<br>import com.example.polls.repository.UserRepository;<br>import com.example.polls.repository.VoteRepository;<br>import com.example.polls.security.UserPrincipal;<br>import com.example.polls.util.AppConstants;<br>import com.example.polls.util.ModelMapper;<br>import org.slf4j.Logger;<br>import org.slf4j.LoggerFactory;<br>import org.springframework.beans.factory.annotation.Autowired;<br>import org.springframework.dao.DataIntegrityViolationException;<br>import org.springframework.data.domain.Page;<br>import org.springframework.data.domain.PageRequest;<br>import org.springframework.data.domain.Pageable;<br>import org.springframework.data.domain.Sort;<br>import org.springframework.stereotype.Service;<br>import java.time.Duration;<br>import java.time.Instant;<br>import java.util.Collections;<br>import java.util.List;<br>import java.util.Map;<br>import java.util.function.Function;<br>import java.util.stream.Collectors;</code></pre><pre name="711e" id="711e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">@Service<br>public class PollService {</code></pre><pre name="1ca2" id="1ca2" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    private PollRepository pollRepository;</code></pre><pre name="cadb" id="cadb" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    private VoteRepository voteRepository;</code></pre><pre name="0e28" id="0e28" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    @Autowired<br>    private UserRepository userRepository;</code></pre><pre name="c63f" id="c63f" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private static final Logger logger = LoggerFactory.getLogger(PollService.class);</code></pre><pre name="96f1" id="96f1" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PagedResponse&lt;PollResponse&gt; getAllPolls(UserPrincipal currentUser, int page, int size) {<br>        validatePageNumberAndSize(page, size);</code></pre><pre name="85e7" id="85e7" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve Polls<br>        Pageable pageable = PageRequest.of(page, size, Sort.Direction.DESC, &quot;createdAt&quot;);<br>        Page&lt;Poll&gt; polls = pollRepository.findAll(pageable);</code></pre><pre name="a2ee" id="a2ee" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if(polls.getNumberOfElements() == 0) {<br>            return new PagedResponse&lt;&gt;(Collections.emptyList(), polls.getNumber(),<br>                    polls.getSize(), polls.getTotalElements(), polls.getTotalPages(), polls.isLast());<br>        }</code></pre><pre name="7b36" id="7b36" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Map Polls to PollResponses containing vote counts and poll creator details<br>        List&lt;Long&gt; pollIds = polls.map(Poll::getId).getContent();<br>        Map&lt;Long, Long&gt; choiceVoteCountMap = getChoiceVoteCountMap(pollIds);<br>        Map&lt;Long, Long&gt; pollUserVoteMap = getPollUserVoteMap(currentUser, pollIds);<br>        Map&lt;Long, User&gt; creatorMap = getPollCreatorMap(polls.getContent());</code></pre><pre name="3a16" id="3a16" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        List&lt;PollResponse&gt; pollResponses = polls.map(poll -&gt; {<br>            return ModelMapper.mapPollToPollResponse(poll,<br>                    choiceVoteCountMap,<br>                    creatorMap.get(poll.getCreatedBy()),<br>                    pollUserVoteMap == null ? null : pollUserVoteMap.getOrDefault(poll.getId(), null));<br>        }).getContent();</code></pre><pre name="1723" id="1723" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return new PagedResponse&lt;&gt;(pollResponses, polls.getNumber(),<br>                polls.getSize(), polls.getTotalElements(), polls.getTotalPages(), polls.isLast());<br>    }</code></pre><pre name="ad71" id="ad71" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PagedResponse&lt;PollResponse&gt; getPollsCreatedBy(String username, UserPrincipal currentUser, int page, int size) {<br>        validatePageNumberAndSize(page, size);</code></pre><pre name="2d9b" id="2d9b" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        User user = userRepository.findByUsername(username)<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;User&quot;, &quot;username&quot;, username));</code></pre><pre name="79a9" id="79a9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve all polls created by the given username<br>        Pageable pageable = PageRequest.of(page, size, Sort.Direction.DESC, &quot;createdAt&quot;);<br>        Page&lt;Poll&gt; polls = pollRepository.findByCreatedBy(user.getId(), pageable);</code></pre><pre name="2e04" id="2e04" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if (polls.getNumberOfElements() == 0) {<br>            return new PagedResponse&lt;&gt;(Collections.emptyList(), polls.getNumber(),<br>                    polls.getSize(), polls.getTotalElements(), polls.getTotalPages(), polls.isLast());<br>        }</code></pre><pre name="a7d4" id="a7d4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Map Polls to PollResponses containing vote counts and poll creator details<br>        List&lt;Long&gt; pollIds = polls.map(Poll::getId).getContent();<br>        Map&lt;Long, Long&gt; choiceVoteCountMap = getChoiceVoteCountMap(pollIds);<br>        Map&lt;Long, Long&gt; pollUserVoteMap = getPollUserVoteMap(currentUser, pollIds);</code></pre><pre name="0586" id="0586" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        List&lt;PollResponse&gt; pollResponses = polls.map(poll -&gt; {<br>            return ModelMapper.mapPollToPollResponse(poll,<br>                    choiceVoteCountMap,<br>                    user,<br>                    pollUserVoteMap == null ? null : pollUserVoteMap.getOrDefault(poll.getId(), null));<br>        }).getContent();</code></pre><pre name="6a68" id="6a68" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return new PagedResponse&lt;&gt;(pollResponses, polls.getNumber(),<br>                polls.getSize(), polls.getTotalElements(), polls.getTotalPages(), polls.isLast());<br>    }</code></pre><pre name="691a" id="691a" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PagedResponse&lt;PollResponse&gt; getPollsVotedBy(String username, UserPrincipal currentUser, int page, int size) {<br>        validatePageNumberAndSize(page, size);</code></pre><pre name="c564" id="c564" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        User user = userRepository.findByUsername(username)<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;User&quot;, &quot;username&quot;, username));</code></pre><pre name="96a6" id="96a6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve all pollIds in which the given username has voted<br>        Pageable pageable = PageRequest.of(page, size, Sort.Direction.DESC, &quot;createdAt&quot;);<br>        Page&lt;Long&gt; userVotedPollIds = voteRepository.findVotedPollIdsByUserId(user.getId(), pageable);</code></pre><pre name="fcb6" id="fcb6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if (userVotedPollIds.getNumberOfElements() == 0) {<br>            return new PagedResponse&lt;&gt;(Collections.emptyList(), userVotedPollIds.getNumber(),<br>                    userVotedPollIds.getSize(), userVotedPollIds.getTotalElements(),<br>                    userVotedPollIds.getTotalPages(), userVotedPollIds.isLast());<br>        }</code></pre><pre name="4b1c" id="4b1c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve all poll details from the voted pollIds.<br>        List&lt;Long&gt; pollIds = userVotedPollIds.getContent();</code></pre><pre name="7dff" id="7dff" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Sort sort = Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;);<br>        List&lt;Poll&gt; polls = pollRepository.findByIdIn(pollIds, sort);</code></pre><pre name="a5b4" id="a5b4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Map Polls to PollResponses containing vote counts and poll creator details<br>        Map&lt;Long, Long&gt; choiceVoteCountMap = getChoiceVoteCountMap(pollIds);<br>        Map&lt;Long, Long&gt; pollUserVoteMap = getPollUserVoteMap(currentUser, pollIds);<br>        Map&lt;Long, User&gt; creatorMap = getPollCreatorMap(polls);</code></pre><pre name="a85d" id="a85d" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        List&lt;PollResponse&gt; pollResponses = polls.stream().map(poll -&gt; {<br>            return ModelMapper.mapPollToPollResponse(poll,<br>                    choiceVoteCountMap,<br>                    creatorMap.get(poll.getCreatedBy()),<br>                    pollUserVoteMap == null ? null : pollUserVoteMap.getOrDefault(poll.getId(), null));<br>        }).collect(Collectors.toList());</code></pre><pre name="12e6" id="12e6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return new PagedResponse&lt;&gt;(pollResponses, userVotedPollIds.getNumber(), userVotedPollIds.getSize(), userVotedPollIds.getTotalElements(), userVotedPollIds.getTotalPages(), userVotedPollIds.isLast());<br>    }<br><br></code></pre><pre name="cfb5" id="cfb5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public Poll createPoll(PollRequest pollRequest) {<br>        Poll poll = new Poll();<br>        poll.setQuestion(pollRequest.getQuestion());</code></pre><pre name="a327" id="a327" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        pollRequest.getChoices().forEach(choiceRequest -&gt; {<br>            poll.addChoice(new Choice(choiceRequest.getText()));<br>        });</code></pre><pre name="728c" id="728c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Instant now = Instant.now();<br>        Instant expirationDateTime = now.plus(Duration.ofDays(pollRequest.getPollLength().getDays()))<br>                .plus(Duration.ofHours(pollRequest.getPollLength().getHours()));</code></pre><pre name="121e" id="121e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        poll.setExpirationDateTime(expirationDateTime);</code></pre><pre name="1e71" id="1e71" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return pollRepository.save(poll);<br>    }</code></pre><pre name="4df3" id="4df3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PollResponse getPollById(Long pollId, UserPrincipal currentUser) {<br>        Poll poll = pollRepository.findById(pollId).orElseThrow(<br>                () -&gt; new ResourceNotFoundException(&quot;Poll&quot;, &quot;id&quot;, pollId));</code></pre><pre name="b9e3" id="b9e3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve Vote Counts of every choice belonging to the current poll<br>        List&lt;ChoiceVoteCount&gt; votes = voteRepository.countByPollIdGroupByChoiceId(pollId);</code></pre><pre name="c9f3" id="c9f3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Map&lt;Long, Long&gt; choiceVotesMap = votes.stream()<br>                .collect(Collectors.toMap(ChoiceVoteCount::getChoiceId, ChoiceVoteCount::getVoteCount));</code></pre><pre name="2755" id="2755" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve poll creator details<br>        User creator = userRepository.findById(poll.getCreatedBy())<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;User&quot;, &quot;id&quot;, poll.getCreatedBy()));</code></pre><pre name="a9fc" id="a9fc" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve vote done by logged in user<br>        Vote userVote = null;<br>        if(currentUser != null) {<br>            userVote = voteRepository.findByUserIdAndPollId(currentUser.getId(), pollId);<br>        }</code></pre><pre name="9543" id="9543" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return ModelMapper.mapPollToPollResponse(poll, choiceVotesMap,<br>                creator, userVote != null ? userVote.getChoice().getId(): null);<br>    }</code></pre><pre name="a5b3" id="a5b3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    public PollResponse castVoteAndGetUpdatedPoll(Long pollId, VoteRequest voteRequest, UserPrincipal currentUser) {<br>        Poll poll = pollRepository.findById(pollId)<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Poll&quot;, &quot;id&quot;, pollId));</code></pre><pre name="5f23" id="5f23" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if(poll.getExpirationDateTime().isBefore(Instant.now())) {<br>            throw new BadRequestException(&quot;Sorry! This Poll has already expired&quot;);<br>        }</code></pre><pre name="0a3c" id="0a3c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        User user = userRepository.getOne(currentUser.getId());</code></pre><pre name="36bf" id="36bf" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Choice selectedChoice = poll.getChoices().stream()<br>                .filter(choice -&gt; choice.getId().equals(voteRequest.getChoiceId()))<br>                .findFirst()<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Choice&quot;, &quot;id&quot;, voteRequest.getChoiceId()));</code></pre><pre name="d82e" id="d82e" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Vote vote = new Vote();<br>        vote.setPoll(poll);<br>        vote.setUser(user);<br>        vote.setChoice(selectedChoice);</code></pre><pre name="6002" id="6002" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        try {<br>            vote = voteRepository.save(vote);<br>        } catch (DataIntegrityViolationException ex) {<br>            logger.info(&quot;User {} has already voted in Poll {}&quot;, currentUser.getId(), pollId);<br>            throw new BadRequestException(&quot;Sorry! You have already cast your vote in this poll&quot;);<br>        }</code></pre><pre name="daa5" id="daa5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        //-- Vote Saved, Return the updated Poll Response now --</code></pre><pre name="72a3" id="72a3" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve Vote Counts of every choice belonging to the current poll<br>        List&lt;ChoiceVoteCount&gt; votes = voteRepository.countByPollIdGroupByChoiceId(pollId);</code></pre><pre name="a5e5" id="a5e5" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Map&lt;Long, Long&gt; choiceVotesMap = votes.stream()<br>                .collect(Collectors.toMap(ChoiceVoteCount::getChoiceId, ChoiceVoteCount::getVoteCount));</code></pre><pre name="de08" id="de08" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        // Retrieve poll creator details<br>        User creator = userRepository.findById(poll.getCreatedBy())<br>                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;User&quot;, &quot;id&quot;, poll.getCreatedBy()));</code></pre><pre name="6b91" id="6b91" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return ModelMapper.mapPollToPollResponse(poll, choiceVotesMap, creator, vote.getChoice().getId());<br>    }<br><br></code></pre><pre name="3877" id="3877" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private void validatePageNumberAndSize(int page, int size) {<br>        if(page &lt; 0) {<br>            throw new BadRequestException(&quot;Page number cannot be less than zero.&quot;);<br>        }</code></pre><pre name="b284" id="b284" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        if(size &gt; AppConstants.MAX_PAGE_SIZE) {<br>            throw new BadRequestException(&quot;Page size must not be greater than &quot; + AppConstants.MAX_PAGE_SIZE);<br>        }<br>    }</code></pre><pre name="b3b9" id="b3b9" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private Map&lt;Long, Long&gt; getChoiceVoteCountMap(List&lt;Long&gt; pollIds) {<br>        // Retrieve Vote Counts of every Choice belonging to the given pollIds<br>        List&lt;ChoiceVoteCount&gt; votes = voteRepository.countByPollIdInGroupByChoiceId(pollIds);</code></pre><pre name="d5f4" id="d5f4" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        Map&lt;Long, Long&gt; choiceVotesMap = votes.stream()<br>                .collect(Collectors.toMap(ChoiceVoteCount::getChoiceId, ChoiceVoteCount::getVoteCount));</code></pre><pre name="8d4c" id="8d4c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return choiceVotesMap;<br>    }</code></pre><pre name="5733" id="5733" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    private Map&lt;Long, Long&gt; getPollUserVoteMap(UserPrincipal currentUser, List&lt;Long&gt; pollIds) {<br>        // Retrieve Votes done by the logged in user to the given pollIds<br>        Map&lt;Long, Long&gt; pollUserVoteMap = null;<br>        if(currentUser != null) {<br>            List&lt;Vote&gt; userVotes = voteRepository.findByUserIdAndPollIdIn(currentUser.getId(), pollIds);</code></pre><pre name="3def" id="3def" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">            pollUserVoteMap = userVotes.stream()<br>                    .collect(Collectors.toMap(vote -&gt; vote.getPoll().getId(), vote -&gt; vote.getChoice().getId()));<br>        }<br>        return pollUserVoteMap;<br>    }</code></pre><pre name="1da0" id="1da0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">    Map&lt;Long, User&gt; getPollCreatorMap(List&lt;Poll&gt; polls) {<br>        // Get Poll Creator details of the given list of polls<br>        List&lt;Long&gt; creatorIds = polls.stream()<br>                .map(Poll::getCreatedBy)<br>                .distinct()<br>                .collect(Collectors.toList());</code></pre><pre name="d585" id="d585" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        List&lt;User&gt; creators = userRepository.findByIdIn(creatorIds);<br>        Map&lt;Long, User&gt; creatorMap = creators.stream()<br>                .collect(Collectors.toMap(User::getId, Function.identity()));</code></pre><pre name="fa12" id="fa12" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">        return creatorMap;<br>    }<br>}</code></pre><h3 name="a2f2" id="a2f2" class="graf graf--h3 graf-after--pre">Running the Application</h3><p name="d9e9" id="d9e9" class="graf graf--p graf-after--h3">You can run the application by typing the following command.</p><pre name="2d3c" id="2d3c" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">mvn spring-boot:run</code></pre><p name="f812" id="f812" class="graf graf--p graf-after--pre">Go ahead and test the APIs that we built in this article by making requests from any rest client like Postman. Write to me in the discussion section if you run into an issue.</p><p name="130f" id="130f" class="graf graf--p graf-after--p">we created the backend project, setup spring security with JWT authentication, and written the rest APIs for Login, Signup, Polls, and Users.</p><p name="8316" id="8316" class="graf graf--p graf-after--p">Then, We’ll build the client side of the application using <a href="https://reactjs.org/" data-href="https://reactjs.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">React</a> and <a href="https://ant.design/" data-href="https://ant.design/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ant Design</a>.</p><h3 name="fc18" id="fc18" class="graf graf--h3 graf-after--p">Bootstrapping the Front End Project</h3><p name="5420" id="5420" class="graf graf--p graf-after--h3">Follow the steps below to setup the front-end project.</p><h3 name="f29a" id="f29a" class="graf graf--h3 graf-after--p">1. Installing create-react-app</h3><p name="a671" id="a671" class="graf graf--p graf-after--h3">First of all, we’ll install <code class="markup--code markup--p-code"><a href="https://github.com/facebook/create-react-app" data-href="https://github.com/facebook/create-react-app" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">create-react-app</a></code>, a command line tool for creating react apps</p><pre name="b2c4" id="b2c4" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npm install -g create-react-app</code></pre><h3 name="285c" id="285c" class="graf graf--h3 graf-after--pre">2. Creating the app</h3><p name="e277" id="e277" class="graf graf--p graf-after--h3">Now let’s create the app using <code class="markup--code markup--p-code">create-react-app</code> tool by typing the following command -</p><pre name="6576" id="6576" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">create-react-app polling-app-client</code></pre><h3 name="c5df" id="c5df" class="graf graf--h3 graf-after--pre">3. Installing Additional Dependencies</h3><p name="b00b" id="b00b" class="graf graf--p graf-after--h3">We’ll be using the following additional dependencies in our project -</p><ol class="postList"><li name="ed0c" id="ed0c" class="graf graf--li graf-after--p"><a href="https://ant.design/docs/react/introduce" data-href="https://ant.design/docs/react/introduce" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">And Design</a>: An excellent react based user interface library for designing the user interface.</li><li name="3e24" id="3e24" class="graf graf--li graf-after--li"><a href="https://github.com/ReactTraining/react-router" data-href="https://github.com/ReactTraining/react-router" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">React Router</a>: Client side routing solution for react apps.</li></ol><p name="b43b" id="b43b" class="graf graf--p graf-after--li">Let’s install these dependencies by typing the following command</p><pre name="c9c9" id="c9c9" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd polling-app-client<br>npm install antd react-router-dom --save</code></pre><p name="45d1" id="45d1" class="graf graf--p graf-after--pre">We’ll also need some dev dependencies to customize Ant Design’s theme and enable on-demand component import. Type the following command to install these dev dependencies -</p><pre name="eeb7" id="eeb7" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npm install react-app-rewired babel-plugin-import react-app-rewire-less --save-dev</code></pre><h3 name="df9e" id="df9e" class="graf graf--h3 graf-after--pre">4. Configuring Ant Design</h3><p name="850e" id="850e" class="graf graf--p graf-after--h3">Now let’s configure ant design and customize its theme by overriding <code class="markup--code markup--p-code">less</code> variables.</p><ul class="postList"><li name="2fb4" id="2fb4" class="graf graf--li graf-after--p">Using react-app-rewired to customize default webpack config</li><li name="03d6" id="03d6" class="graf graf--li graf-after--li">We’ll use react-app-rewired to enable customization. Open <code class="markup--code markup--li-code">package.json</code> file and replace the following scripts</li></ul><pre name="4a7e" id="4a7e" class="graf graf--pre graf-after--li">&quot;scripts&quot;: {<br>&quot;start&quot;: &quot;react-scripts start&quot;,<br>&quot;build&quot;: &quot;react-scripts build&quot;,<br>&quot;test&quot;: &quot;react-scripts test --env=jsdom&quot;,<br>&quot;eject&quot;: &quot;react-scripts eject&quot;<br>}</pre><p name="f84f" id="f84f" class="graf graf--p graf-after--pre">with these scripts -</p><pre name="59e0" id="59e0" class="graf graf--pre graf-after--p">&quot;scripts&quot;: {<br>  &quot;start&quot;: &quot;react-app-rewired start&quot;,<br>  &quot;build&quot;: &quot;react-app-rewired build&quot;,<br>  &quot;test&quot;: &quot;react-app-rewired test --env=jsdom&quot;,<br>  &quot;eject&quot;: &quot;react-scripts eject&quot;<br>}</pre><p name="1bb7" id="1bb7" class="graf graf--p graf-after--pre">Overriding configurations with config-overrides.js</p><p name="6211" id="6211" class="graf graf--p graf-after--p">Now create a file named <code class="markup--code markup--p-code">config-overrides.js</code> in the root directory of the project and add the following code to it -</p><pre name="5583" id="5583" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">const { injectBabelPlugin } = require(&#39;react-app-rewired&#39;);<br>const rewireLess = require(&#39;react-app-rewire-less&#39;);</code></pre><pre name="1ff0" id="1ff0" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">module.exports = function override(config, env) {<br>    config = injectBabelPlugin([&#39;import&#39;, { libraryName: &#39;antd&#39;, style: true }], config);<br>    config = rewireLess.withLoaderOptions({<br>      modifyVars: {<br>          &quot;@layout-body-background&quot;: &quot;#FFFFFF&quot;,<br>          &quot;@layout-header-background&quot;: &quot;#FFFFFF&quot;,<br>          &quot;@layout-footer-background&quot;: &quot;#FFFFFF&quot;<br>      },<br>      javascriptEnabled: true<br>    })(config, env);<br>    return config;<br>};</code></pre><ul class="postList"><li name="0690" id="0690" class="graf graf--li graf-after--pre">Notice how we’re overriding Ant Design’s default less variables to customize the theme as per our needs.</li></ul><h3 name="8ab0" id="8ab0" class="graf graf--h3 graf-after--li">5. Running the App</h3><p name="f894" id="f894" class="graf graf--p graf-after--h3">We’re done with all the configurations. Let’s run the app by typing the following command -</p><pre name="e088" id="e088" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npm start</code></pre><h3 name="b139" id="b139" class="graf graf--h3 graf-after--pre">Exploring the directory structure of the Project</h3><p name="e446" id="e446" class="graf graf--p graf-after--h3">Following is the directory structure of the complete front-end project.</p><pre name="0360" id="0360" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">polling-app-client<br>  ↳ public<br>        ↳ favicon.png<br>        ↳ index.html<br>        ↳ manifest.json<br>  ↳ src<br>     ↳ app<br>         ↳ App.css<br>         ↳ App.js<br>     ↳ common<br>         ↳ AppHeader.css<br>         ↳ AppHeader.js<br>         ↳ LoadingIndicator.js<br>         ↳ NotFound.css<br>         ↳ NotFound.js<br>         ↳ PrivateRoute.js<br>         ↳ ServerError.css<br>         ↳ ServerError.js<br>     ↳ constants<br>         ↳ index.js<br>     ↳ poll<br>         ↳ NewPoll.css<br>         ↳ NewPoll.js<br>         ↳ Poll.css<br>         ↳ Poll.js<br>         ↳ PollList.css<br>         ↳ PollList.js    <br>     ↳ user<br>         ↳ login<br>             ↳ Login.css<br>             ↳ Login.js<br>         ↳ profile<br>             ↳ Profile.css<br>             ↳ Profile.js<br>         ↳ signup<br>             ↳ Signup.css<br>             ↳ Signup.js<br>     ↳ util<br>         ↳ APIUtils.js<br>         ↳ Colors.js<br>         ↳ Helpers.js<br>     ↳ index.css<br>     ↳ index.js<br>     ↳ logo.svg<br>     ↳ poll.svg<br>     ↳ registerServiceWorker.js                              <br>  ↳ config-overrides.js<br>  ↳ package.json</code></pre><p name="68b3" id="68b3" class="graf graf--p graf-after--pre">I’ll give you a brief idea of how the project is structured and what each directory and files do.</p><p name="7659" id="7659" class="graf graf--p graf-after--p">Going through every piece of code in this blog will be very time consuming, and is absolutely unnecessary. The code is simple and self-explanatory. A basic knowledge of React is needed to understand the code.</p><p name="beae" id="beae" class="graf graf--p graf-after--p">All right! Let’s understand some of the important pieces of code in our front-end project.</p><h3 name="a652" id="a652" class="graf graf--h3 graf-after--p">Understanding the front-end code</h3><h3 name="90b0" id="90b0" class="graf graf--h3 graf-after--h3">index.js</h3><p name="7be5" id="7be5" class="graf graf--p graf-after--h3">This file is the main entry point of our react application -</p><pre name="9e65" id="9e65" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">import React from &#39;react&#39;;<br>import ReactDOM from &#39;react-dom&#39;;<br>import &#39;./index.css&#39;;<br>import App from &#39;./app/App&#39;;<br>import registerServiceWorker from &#39;./registerServiceWorker&#39;;<br>import { BrowserRouter as Router } from &#39;react-router-dom&#39;;</code></pre><pre name="aaf6" id="aaf6" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">ReactDOM.render(<br>    &lt;Router&gt;<br>        &lt;App /&gt;<br>    &lt;/Router&gt;, <br>    document.getElementById(&#39;root&#39;)<br>);</code></pre><pre name="00ea" id="00ea" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">registerServiceWorker();</code></pre><p name="e8bc" id="e8bc" class="graf graf--p graf-after--pre">In the above script, we simply render the <code class="markup--code markup--p-code">App</code> component in a DOM element with id <code class="markup--code markup--p-code">root</code> (This DOM element is available in <code class="markup--code markup--p-code">public/index.html</code> file).</p><h3 name="2c2c" id="2c2c" class="graf graf--h3 graf-after--p">src/app/App.js</h3><p name="2594" id="2594" class="graf graf--p graf-after--h3">It defines the <code class="markup--code markup--p-code">App</code> component. The <code class="markup--code markup--p-code">App</code> component is the main top-level component of our application. It defines the primary layout and routing, loads the currently logged in user, and passes the <code class="markup--code markup--p-code">currentUser</code> and <code class="markup--code markup--p-code">isAuthenticated</code> property to other components.</p><pre name="afb8" id="afb8" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">import React, { Component } from &#39;react&#39;;<br>import &#39;./App.css&#39;;<br>import {<br>  Route,<br>  withRouter,<br>  Switch<br>} from &#39;react-router-dom&#39;;<br><br>import { getCurrentUser } from &#39;../util/APIUtils&#39;;<br>import { ACCESS_TOKEN } from &#39;../constants&#39;;<br><br>import PollList from &#39;../poll/PollList&#39;;<br>import NewPoll from &#39;../poll/NewPoll&#39;;<br>import Login from &#39;../user/login/Login&#39;;<br>import Signup from &#39;../user/signup/Signup&#39;;<br>import Profile from &#39;../user/profile/Profile&#39;;<br>import AppHeader from &#39;../common/AppHeader&#39;;<br>import NotFound from &#39;../common/NotFound&#39;;<br>import LoadingIndicator from &#39;../common/LoadingIndicator&#39;;<br>import PrivateRoute from &#39;../common/PrivateRoute&#39;;<br><br>import { Layout, notification } from &#39;antd&#39;;<br>const { Content } = Layout;<br><br>class App extends Component {<br>  constructor(props) {<br>    super(props);<br>    this.state = {<br>      currentUser: null,<br>      isAuthenticated: false,<br>      isLoading: false<br>    }<br>    this.handleLogout = this.handleLogout.bind(this);<br>    this.loadCurrentUser = this.loadCurrentUser.bind(this);<br>    this.handleLogin = this.handleLogin.bind(this);<br><br>    notification.config({<br>      placement: &#39;topRight&#39;,<br>      top: 70,<br>      duration: 3,<br>    });    <br>  }<br><br>  loadCurrentUser() {<br>    this.setState({<br>      isLoading: true<br>    });<br>    getCurrentUser()<br>    .then(response =&gt; {<br>      this.setState({<br>        currentUser: response,<br>        isAuthenticated: true,<br>        isLoading: false<br>      });<br>    }).catch(error =&gt; {<br>      this.setState({<br>        isLoading: false<br>      });  <br>    });<br>  }<br><br>  componentDidMount() {<br>    this.loadCurrentUser();<br>  }<br><br>  // Handle Logout, Set currentUser and isAuthenticated state which will be passed to other components<br>  handleLogout(redirectTo=&quot;/&quot;, notificationType=&quot;success&quot;, description=&quot;You&#39;re successfully logged out.&quot;) {<br>    localStorage.removeItem(ACCESS_TOKEN);<br><br>    this.setState({<br>      currentUser: null,<br>      isAuthenticated: false<br>    });<br><br>    this.props.history.push(redirectTo);<br>    <br>    notification[notificationType]({<br>      message: &#39;Polling App&#39;,<br>      description: description,<br>    });<br>  }<br><br>  /* <br>   This method is called by the Login component after successful login <br>   so that we can load the logged-in user details and set the currentUser &amp;<br>   isAuthenticated state, which other components will use to render their JSX<br>  */<br>  handleLogin() {<br>    notification.success({<br>      message: &#39;Polling App&#39;,<br>      description: &quot;You&#39;re successfully logged in.&quot;,<br>    });<br>    this.loadCurrentUser();<br>    this.props.history.push(&quot;/&quot;);<br>  }<br><br>  render() {<br>    if(this.state.isLoading) {<br>      return &lt;LoadingIndicator /&gt;<br>    }<br>    return (<br>        &lt;Layout className=&quot;app-container&quot;&gt;<br>          &lt;AppHeader isAuthenticated={this.state.isAuthenticated} <br>            currentUser={this.state.currentUser} <br>            onLogout={this.handleLogout} /&gt;<br><br>          &lt;Content className=&quot;app-content&quot;&gt;<br>            &lt;div className=&quot;container&quot;&gt;<br>              &lt;Switch&gt;      <br>                &lt;Route exact path=&quot;/&quot; <br>                  render={(props) =&gt; &lt;PollList isAuthenticated={this.state.isAuthenticated} <br>                      currentUser={this.state.currentUser} handleLogout={this.handleLogout} {...props} /&gt;}&gt;<br>                &lt;/Route&gt;<br>                &lt;Route path=&quot;/login&quot; <br>                  render={(props) =&gt; &lt;Login onLogin={this.handleLogin} {...props} /&gt;}&gt;&lt;/Route&gt;<br>                &lt;Route path=&quot;/signup&quot; component={Signup}&gt;&lt;/Route&gt;<br>                &lt;Route path=&quot;/users/:username&quot; <br>                  render={(props) =&gt; &lt;Profile isAuthenticated={this.state.isAuthenticated} currentUser={this.state.currentUser} {...props}  /&gt;}&gt;<br>                &lt;/Route&gt;<br>                &lt;PrivateRoute authenticated={this.state.isAuthenticated} path=&quot;/poll/new&quot; component={NewPoll} handleLogout={this.handleLogout}&gt;&lt;/PrivateRoute&gt;<br>                &lt;Route component={NotFound}&gt;&lt;/Route&gt;<br>              &lt;/Switch&gt;<br>            &lt;/div&gt;<br>          &lt;/Content&gt;<br>        &lt;/Layout&gt;<br>    );<br>  }<br>}<br><br>export default withRouter(App);<br><br></code></pre><h3 name="72e6" id="72e6" class="graf graf--h3 graf-after--pre">src/common — Common Components</h3><ul class="postList"><li name="8ba9" id="8ba9" class="graf graf--li graf-after--h3">AppHeader.js: Header component which renders Login &amp; SignUp buttons for unauthenticated users, and Home, Profile &amp; Create Poll buttons for authenticated users.</li><li name="15c5" id="15c5" class="graf graf--li graf-after--li">LoadingIndicator.js: It is used by other components to render a loading indicator while an API call is in progress.</li><li name="7a1a" id="7a1a" class="graf graf--li graf-after--li">NotFound.js: We use this in <code class="markup--code markup--li-code">App</code> component to render a 404 Not Found page if none of the routes match the current url.</li><li name="8df3" id="8df3" class="graf graf--li graf-after--li">PrivateRoute.js: A meta component that redirects to <code class="markup--code markup--li-code">/login</code> if the user is trying to access a protected page without authentication.</li><li name="c686" id="c686" class="graf graf--li graf-after--li">ServerError.js: Other components use this to render a 500 Server Error page if any API responds with a 500 error which the component can’t handle.</li></ul><h3 name="b683" id="b683" class="graf graf--h3 graf-after--li">src/constants</h3><p name="a920" id="a920" class="graf graf--p graf-after--h3">I’ve defined all the global constants in <code class="markup--code markup--p-code">src/constants/index.js</code> file for other components use -</p><pre name="9591" id="9591" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">export const API_BASE_URL = &#39;http://localhost:5000&#39;;<br>export const ACCESS_TOKEN = &#39;accessToken&#39;;</code></pre><pre name="1361" id="1361" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">export const POLL_LIST_SIZE = 30;<br>export const MAX_CHOICES = 6;<br>export const POLL_QUESTION_MAX_LENGTH = 140;<br>export const POLL_CHOICE_MAX_LENGTH = 40;</code></pre><pre name="280c" id="280c" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">export const NAME_MIN_LENGTH = 4;<br>export const NAME_MAX_LENGTH = 40;</code></pre><pre name="98db" id="98db" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">export const USERNAME_MIN_LENGTH = 3;<br>export const USERNAME_MAX_LENGTH = 15;</code></pre><pre name="d832" id="d832" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">export const EMAIL_MAX_LENGTH = 40;</code></pre><pre name="6200" id="6200" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">export const PASSWORD_MIN_LENGTH = 6;<br>export const PASSWORD_MAX_LENGTH = 20;</code></pre><h3 name="0c8a" id="0c8a" class="graf graf--h3 graf-after--pre">src/poll</h3><ul class="postList"><li name="bf24" id="bf24" class="graf graf--li graf-after--h3">NewPoll.js: Renders the Poll creation form.</li><li name="0bf3" id="0bf3" class="graf graf--li graf-after--li">PollList.js: This component is used to render a list of polls. It is used to render all polls on the home page. We also use this in user’s profile page to render the list of polls created by that user, and the list of polls in which that user has voted.</li><li name="ddf0" id="ddf0" class="graf graf--li graf-after--li">Poll.js: It is used by the <code class="markup--code markup--li-code">PollList</code> component to render a single Poll.</li></ul><h3 name="5468" id="5468" class="graf graf--h3 graf-after--li">src/user</h3><ul class="postList"><li name="54d4" id="54d4" class="graf graf--li graf-after--h3">login/Login.js: The Login component renders the Login form calls the login API to authenticate a user.</li><li name="213f" id="213f" class="graf graf--li graf-after--li">signup/Signup.js: It renders the registration form and contains a bunch of client-side validations. It’s an interesting component to check out if you want to learn how to do form validations in React.</li><li name="0c6d" id="0c6d" class="graf graf--li graf-after--li">profile/Profile.js: The profile page renders a user’s public profile. It displays user’s basic information, the list of polls that the user has created, and the list of polls in which the user has voted.</li></ul><h3 name="4f74" id="4f74" class="graf graf--h3 graf-after--li">src/util</h3><ul class="postList"><li name="d0d2" id="d0d2" class="graf graf--li graf-after--h3">APIUtils.js: All the Rest API calls are written in this script. It uses the <code class="markup--code markup--li-code">fetch</code> API to make requests to the backend server.</li><li name="2364" id="2364" class="graf graf--li graf-after--li">Colors.js: This util is used to get a random color to use in user’s avatar.</li><li name="8d12" id="8d12" class="graf graf--li graf-after--li">Helpers.js: It contains helper functions to format dates.</li></ul><h3 name="d575" id="d575" class="graf graf--h3 graf-after--li">Running the app</h3><p name="8a01" id="8a01" class="graf graf--p graf-after--h3">You can run the react app using <code class="markup--code markup--p-code">npm</code> like this -</p><pre name="3ea5" id="3ea5" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">cd polling-app-client<br>npm install &amp;&amp; npm start</code></pre><p name="3a7e" id="3a7e" class="graf graf--p graf-after--pre">The above command will install any missing dependencies and start the app on port <code class="markup--code markup--p-code">3000</code>.</p><p name="92f1" id="92f1" class="graf graf--p graf-after--p">If you just want to build the app, then type the following command -</p><pre name="47ab" id="47ab" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">npm run build</code></pre><p name="40a0" id="40a0" class="graf graf--p graf-after--pre">The above command will create an optimized production build in a directory named <code class="markup--code markup--p-code">build/</code>.</p><h3 name="d60d" id="d60d" class="graf graf--h3 graf-after--p">Over to you</h3><p name="f939" id="f939" class="graf graf--p graf-after--h3">I always prefer writing practical end-to-end tutorials on this blog. Full stack end-to-end tutorials like this one give you a broader picture of the application and lets you think through the challenges that are faced in all the stacks.</p><p name="45c5" id="45c5" class="graf graf--p graf-after--p">I hope that I didn’t overwhelm you with lots of code, and you were able to follow along and learn the concepts.</p><p name="a4e6" id="a4e6" class="graf graf--p graf-after--p">If something is unclear and you want me to explain it in detail, then let me know in the discussion section below. I’ll do my best to explain it to you.</p><p name="7afe" id="7afe" class="graf graf--p graf-after--p">At last, I have some homework for you :) There are still a lot of stuff that we can improve in our polls app. I want you to work on them and submit a pull request on <a href="https://github.com/DimuthuKasunWP/spring-hibernate-security-react-ant-design-polling-app" data-href="https://github.com/DimuthuKasunWP/spring-hibernate-security-react-ant-design-polling-app" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github</a>.</p><p name="15ed" id="15ed" class="graf graf--p graf-after--p">So here are some of the improvements that will make the polls app more awesome -</p><ul class="postList"><li name="4d78" id="4d78" class="graf graf--li graf-after--p">Email verification: There is no email verification right now in our application. Anyone can register with a random email. Write the logic to send an email verification mail to newly registered users with a verification link and verify user’s email once he clicks on the link.</li><li name="d801" id="d801" class="graf graf--li graf-after--li">Edit Profile: Add an edit profile page where a user can change his name, username, email, and password.</li><li name="4a80" id="4a80" class="graf graf--li graf-after--li">Forgot Password: Add forgot password functionality in the app.</li></ul><p name="5a2b" id="5a2b" class="graf graf--p graf-after--li graf--trailing">I encourage you to implement the above functionalities. You will find many articles on the internet explaining how to implement things like email verification, forgot password etc. If you don’t find a proper answer on the internet, then write to me in the discussion section below or send me an email. I’ll help you out.</p></div></div></section>
</section>
</article></body></html>